<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Journey Planner - RC Beverages</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header {
      background-color: #0057b7;
      color: white;
      padding: 20px;
      text-align: center;
      position: fixed;
      top: 0; width: 100%; z-index: 1000;
    }
    .week-header {
      background: #ffffff;
      color: #0057b7;
      font-size: 1.2rem;
      padding: 10px;
      margin-top: 80px;
      text-align: center;
      font-weight: bold;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      padding: 20px;
      margin-bottom: 100px;
    }
    .day-column {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .day-header {
      background: #2563eb;
      color: white;
      padding: 10px;
      font-weight: bold;
      text-align: center;
    }
    .slots {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 5px;
    }
    .slot {
      background: #eef3fd;
      border: 1px dashed #ccc;
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      font-size: 0.9rem;
      min-height: 50px;
      position: relative;
    }
    .slot.complete {
      background: #a7f3d0;
      position: relative;
    }
    .slot.complete::after {
      content: "âœ“";
      color: green;
      font-weight: bold;
      position: absolute;
      top: 5px;
      right: 8px;
    }
    .add-visit-btn {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 8px 10px;
      font-size: 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }
    .add-visit-btn:hover { background-color: #1e40af; }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #cfe2ff;
      padding: 10px 0;
      display: flex;
      justify-content: space-around;
      border-top: 2px solid #ccc;
      z-index: 999;
    }
    .footer-btn {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1rem;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s ease-in-out;
    }
    .footer-btn:hover { background-color: #1e40af; }

    /* Modal styles */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
      max-height: 80%;
      overflow-y: auto;
    }
    .modal-header {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .store-list {
      margin-top: 10px;
    }
    .store-item {
      padding: 8px;
      background: #eef3fd;
      margin-bottom: 5px;
      border-radius: 6px;
      cursor: pointer;
    }
    .store-item:hover {
      background: #cfe2ff;
    }
    .search-input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
  </style>
</head>
<body>
<header>
  <h1>Journey Planner</h1>
</header>
<div class="week-header" id="weekHeader">Week of ...</div>
<div class="calendar" id="calendar"></div>

<!-- Modal for Add Visit -->
<div class="modal" id="addVisitModal">
  <div class="modal-content">
    <div class="modal-header">Select Store to Add Visit</div>
    <input type="text" id="searchStore" class="search-input" placeholder="Search Store...">
    <div class="store-list" id="storeList"></div>
  </div>
</div>

<footer>
  <button class="footer-btn" onclick="location.href='dashboard.html'">Dashboard</button>
  <button class="footer-btn" onclick="location.href='journeyplanners.html'">Journey Planner</button>
  <button class="footer-btn" onclick="location.href='reminders.html'">Reminders</button>
  <button class="footer-btn" onclick="location.href='portfolio.html'">Portfolio</button>
</footer><script>
let currentMonday = getMonday(new Date());
const calendarContainer = document.getElementById("calendar");
const weekHeader = document.getElementById("weekHeader");
const modal = document.getElementById("addVisitModal");
const storeListContainer = document.getElementById("storeList");
const searchInput = document.getElementById("searchStore");
let selectedSlot = null;

const username = localStorage.getItem("username");
const sheetDBUrl = "https://sheetdb.io/api/v1/9envyaeemiz9h";
const customerSheetUrl = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
let stores = [];
let plannedVisits = [];

function getMonday(d) {
  d = new Date(d);
  let day = d.getDay(),
      diff = d.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(d.setDate(diff));
}

function formatDate(date) {
  return date.toISOString().split("T")[0];
}

function formatWeekRange(date) {
  const monday = new Date(date);
  const friday = new Date(monday);
  friday.setDate(monday.getDate() + 4);
  return `${monday.toLocaleDateString()} - ${friday.toLocaleDateString()}`;
}

function updateWeekHeader() {
  weekHeader.textContent = `Week of ${formatWeekRange(currentMonday)}`;
}

function fetchStoresAndVisits() {
  Promise.all([
    fetch(customerSheetUrl).then(res => res.json()),
    fetch(sheetDBUrl).then(res => res.json())
  ])
  .then(([storeData, visitData]) => {
    stores = storeData.filter(s => s.BDM === username);
    plannedVisits = visitData.filter(v => v.BDM === username);
    renderCalendar();
  });
}

function renderCalendar() {
  calendarContainer.innerHTML = "";
  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
  days.forEach((day, i) => {
    const date = new Date(currentMonday);
    date.setDate(date.getDate() + i);
    const dayDate = formatDate(date);

    const dayColumn = document.createElement("div");
    dayColumn.className = "day-column";
    dayColumn.innerHTML = `<div class="day-header">${day}</div><div class="slots" id="slots-${dayDate}"></div>`;
    calendarContainer.appendChild(dayColumn);

    const slotsContainer = document.getElementById(`slots-${dayDate}`);

    const dayVisits = plannedVisits
      .filter(v => v.Date === dayDate && v.Status !== "Deleted")
      .sort((a, b) => a.Order - b.Order);

    for (let j = 1; j <= 20; j++) {
      const existing = dayVisits.find(v => parseInt(v.Order) === j);
      const slot = document.createElement("div");
      slot.className = existing ? "slot complete" : "slot";
      if (existing) {
        slot.innerHTML = `
          <strong>${existing["Customer Name"]}</strong><br>${existing["Grade"]} - ${existing["Key Account Group"]}
          <br><button onclick="startVisit('${existing["Customer Name"]}')">Start Visit</button>
        `;
      } else {
        slot.innerHTML = `<button class="add-visit-btn" onclick="openAddVisit('${dayDate}', ${j})">Add Visit</button>`;
      }
      slotsContainer.appendChild(slot);
    }
  });
}function openAddVisit(date, order) {
  selectedSlot = { date, order };
  document.getElementById("storeSearchModal").style.display = "block";
  renderStoreList();
}

function closeAddVisit() {
  document.getElementById("storeSearchModal").style.display = "none";
  selectedSlot = null;
}

function renderStoreList() {
  const list = storeListContainer;
  list.innerHTML = "";

  const alreadyPlanned = plannedVisits
    .filter(v => v.Date === selectedSlot.date)
    .map(v => v["Customer Name"]);

  const filteredStores = stores.filter(store => !alreadyPlanned.includes(store["Customer Name"]));

  filteredStores.forEach(store => {
    const item = document.createElement("div");
    item.className = "store-item";
    item.innerHTML = `
      <strong>${store["Customer Name"]}</strong> - ${store["Grade"]} - ${store["Key Account Group"]}
      <button onclick="confirmAddVisit('${store["Customer Name"]}', '${store["Grade"]}', '${store["Key Account Group"]}')">Add</button>
    `;
    list.appendChild(item);
  });
}

function confirmAddVisit(customerName, grade, keyGroup) {
  const visit = {
    "Date": selectedSlot.date,
    "Order": selectedSlot.order,
    "Customer Name": customerName,
    "BDM": username,
    "Grade": grade,
    "Key Account Group": keyGroup,
    "Status": ""
  };

  fetch(sheetDBUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ data: visit })
  })
  .then(() => {
    closeAddVisit();
    fetchStoresAndVisits();
  });
}

function startVisit(customerName) {
  localStorage.setItem("selectedCustomerName", customerName);
  window.location.href = "visit.html";
}

searchInput.addEventListener("input", function() {
  const value = this.value.toLowerCase();
  const items = storeListContainer.querySelectorAll(".store-item");
  items.forEach(item => {
    item.style.display = item.textContent.toLowerCase().includes(value) ? "block" : "none";
  });
});

document.getElementById("prevWeekBtn").addEventListener("click", () => {
  currentMonday.setDate(currentMonday.getDate() - 7);
  updateWeekHeader();
  fetchStoresAndVisits();
});

document.getElementById("nextWeekBtn").addEventListener("click", () => {
  currentMonday.setDate(currentMonday.getDate() + 7);
  updateWeekHeader();
  fetchStoresAndVisits();
});

// Initialize
updateWeekHeader();
fetchStoresAndVisits();
</script><!-- Store Search Modal -->
<div id="storeSearchModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Select a Store</h3>
      <button onclick="closeAddVisit()">Close</button>
    </div>
    <input type="text" id="storeSearchInput" placeholder="Search stores..." />
    <div id="storeList"></div>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex; align-items: center; justify-content: center;
  z-index: 2000;
}

.modal-content {
  background: white;
  width: 90%;
  max-width: 500px;
  padding: 20px;
  border-radius: 10px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#storeSearchInput {
  width: 100%;
  padding: 10px;
  margin: 10px 0 20px 0;
  border-radius: 5px;
  border: 1px solid #ccc;
}

.store-item {
  margin-bottom: 10px;
  padding: 10px;
  background: #eef3fd;
  border-radius: 5px;
}

.store-item button {
  margin-top: 5px;
  background: #2563eb;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}

.store-item button:hover {
  background: #1e40af;
}
</style>

</body>
</html>
