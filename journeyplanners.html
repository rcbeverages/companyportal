<!DOCTYPE html>
<html>
<head>
  <title>Scheduled Calls</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #0057b7;
      color: white;
      text-align: center;
      padding: 1rem;
    }
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 1rem;
      gap: 1rem;
    }
    .slots {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 1rem;
      max-width: 700px;
      margin: auto;
    }
    .slot {
      background-color: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      position: relative;
      min-height: 80px;
    }
    .slot-header {
      font-weight: bold;
    }
    .slot-buttons button {
      margin-top: 0.5rem;
      margin-right: 8px;
      padding: 6px 10px;
    }
    .btn {
      background-color: #0057b7;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #0045a0;
    }
    #addCallModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #addCallModal .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-height: 90vh;
      overflow-y: auto;
      width: 90%;
      max-width: 500px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Scheduled Calls</h1>
  </header>

  <div class="controls">
    <button class="btn" onclick="setToday()">Today</button>
    <input type="date" id="datePicker" onchange="loadDay(this.value)">
  </div>

  <div style="text-align:center;">
    <button class="btn" onclick="openAddCalls()">+ Add Calls</button>
  </div>

  <div id="dayTitle" style="text-align:center; font-size:1.3rem; margin-top: 10px;"></div>
  <div id="slots" class="slots"></div>

  <div id="addCallModal">
    <div class="modal-content">
      <h3>Add Calls for Selected Date</h3>
      <input type="text" id="searchInput" placeholder="Search stores..." style="width: 100%; margin-bottom: 10px; padding: 6px;" oninput="filterCustomers()">
      <div id="customerSelect" style="max-height:300px; overflow-y:auto; border:1px solid #ccc; margin:10px 0; padding:5px;"></div>
      <button class="btn" onclick="submitCalls()">Add Calls</button>
      <button class="btn" onclick="closeAddCalls()" style="margin-left:10px; background-color: gray;">Cancel</button>
    </div>
  </div>

<script>
const sheetEndpoint = "https://sheetdb.io/api/v1/9envyaeemiz9h";
const customerEndpoint = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
const username = localStorage.getItem("username");
const bdmMap = { rhincksman: "Ryan Hincksman", chawkins: "Chris Hawkins" };
const bdmName = bdmMap[username];
let currentDate = new Date().toISOString().split("T")[0];
let currentCalls = [];
let customerCache = [];

function setToday() {
  currentDate = new Date().toISOString().split("T")[0];
  document.getElementById("datePicker").value = currentDate;
  loadDay(currentDate);
}

function loadDay(date) {
  currentDate = date;
  document.getElementById("dayTitle").textContent = `Scheduled Calls for ${new Date(date).toDateString()}`;
  fetch(sheetEndpoint)
    .then(res => res.json())
    .then(data => {
      currentCalls = data
        .filter(d => d.Date?.startsWith(date) && d.BDM === bdmName && d.Status !== "Deleted")
        .sort((a, b) => Number(a.Order || 999) - Number(b.Order || 999));
      renderSlots(currentCalls);
    });
}

function renderSlots(calls) {
  const container = document.getElementById("slots");
  container.innerHTML = "";
  for (let i = 0; i < 20; i++) {
    const call = calls[i];
    const slot = document.createElement("div");
    slot.className = "slot";
    if (call) {
      slot.innerHTML = `
        <div class="slot-header">${call["Customer Name"]}</div>
        <div><strong>Sub Owner:</strong> ${call["Sub Owner Group"] || "-"}</div>
        <div><strong>Key Account:</strong> ${call["Key Account Group"] || "-"}</div>
        <div><strong>Grade:</strong> ${call["Grade"] || "-"}</div>
        <div class="slot-buttons">
          <button class="btn" onclick="startCall('${call["Customer Name"]}')">Start</button>
          <button class="btn" onclick="removeCall('${call["Customer Name"]}')" style="background-color:#c0392b;">Remove</button>
        </div>`;
    } else {
      slot.innerHTML = `<div class="slot-header">[Empty Slot]</div>`;
    }
    container.appendChild(slot);
  }
}

function startCall(customerName) {
  fetch(customerEndpoint)
    .then(res => res.json())
    .then(data => {
      const match = data.find(c => c["Customer Name"] === customerName);
      if (match) {
        localStorage.setItem("selectedCustomer", JSON.stringify(match));
        window.location.href = "visit.html";
      } else {
        alert("Customer not found.");
      }
    });
}

function removeCall(customerName) {
  fetch(`${sheetEndpoint}/search?Customer%20Name=${encodeURIComponent(customerName)}&Date=${currentDate}`)
    .then(res => res.json())
    .then(data => {
      const match = data.find(d => d.Date.startsWith(currentDate) && d.BDM === bdmName);
      if (!match || !match.id) return alert("Matching call has no ID.");
      return fetch(`${sheetEndpoint}/id/${match.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: { Status: "Deleted" } })
      });
    })
    .then(() => loadDay(currentDate));
}

function openAddCalls() {
  document.getElementById("addCallModal").style.display = "flex";
  loadCustomers();
}

function closeAddCalls() {
  document.getElementById("addCallModal").style.display = "none";
}

function loadCustomers() {
  fetch(customerEndpoint)
    .then(res => res.json())
    .then(data => {
      customerCache = data.filter(c => c.BDM === bdmName);
      renderCustomerOptions(customerCache);
    });
}

function filterCustomers() {
  const query = document.getElementById("searchInput").value.toLowerCase();
  const filtered = customerCache.filter(c =>
    c["Customer Name"].toLowerCase().includes(query)
  );
  renderCustomerOptions(filtered);
}

function renderCustomerOptions(list) {
  const container = document.getElementById("customerSelect");
  container.innerHTML = list.map(c =>
    `<label><input type="checkbox" value="${c['Customer Name']}" data-bdm="${c.BDM}" data-grade="${c.Grade}" data-key="${c['Key Account Group']}" data-sub="${c['Sub Owner Group']}" /> ${c['Customer Name']}</label><br/>`
  ).join('');
}

function submitCalls() {
  const selected = [...document.querySelectorAll("#customerSelect input:checked")];
  if (selected.length === 0) return alert("Select at least one customer.");
  fetch(sheetEndpoint)
    .then(res => res.json())
    .then(existing => {
      const todays = existing.filter(c => c.Date?.startsWith(currentDate) && c.BDM === bdmName && c.Status !== "Deleted");
      const maxOrder = Math.max(0, ...todays.map(c => Number(c.Order || 0)));
      const newData = selected.map((el, i) => ({
        "Customer Name": el.value,
        "Date": currentDate,
        "BDM": el.dataset.bdm,
        "Grade": el.dataset.grade,
        "Key Account Group": el.dataset.key,
        "Sub Owner Group": el.dataset.sub,
        "Order": maxOrder + i + 1
      }));
      return fetch(sheetEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: newData })
      });
    })
    .then(() => {
      closeAddCalls();
      loadDay(currentDate);
    });
}

window.onload = function () {
  document.getElementById("datePicker").value = currentDate;
  loadDay(currentDate);
};
</script>
</body>
</html>
