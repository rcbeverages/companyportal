<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Journey Planner - RC Beverages</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .calendar-container {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .week-header {
      font-size: 1.3rem;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
      color: #0057b7;
    }
    .week-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .week-controls button {
      background: #2563eb;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .days-row {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
    }
    .day-column {
      flex: 1;
      min-width: 200px;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 1rem;
    }
    .day-header {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .slot {
      background: white;
      border: 1px solid #ddd;
      padding: 0.5rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      text-align: center;
      font-size: 0.95rem;
    }
    .slot.completed {
      background-color: #d1fae5;
    }
    .add-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Journey Planner</h1>
  </header>
  <div class="welcome-message">Welcome <span id="username"></span></div>  <div class="form-container">
    <div class="calendar-container">
      <div class="week-header" id="weekRange">Week of ...</div>
      <div class="week-controls">
        <button onclick="changeWeek(-7)">Previous Week</button>
        <button onclick="changeWeek(7)">Next Week</button>
      </div>
      <div class="days-row" id="daysContainer"></div>
    </div>
  </div>  <footer>
    <button class="footer-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
    <button class="footer-btn" onclick="location.href='visit.html'">Visit Log</button>
    <button class="footer-btn" onclick="location.href='reminders.html'">Reminders</button>
    <button class="footer-btn" onclick="location.href='portfolio.html'">Portfolio</button>
  </footer>  <script>
    const apiURL = "https://sheetdb.io/api/v1/9envyaeemiz9h";
    const customerAPI = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
    let currentMonday = getMonday(new Date());
    const bdm = localStorage.getItem("username");
    document.getElementById("username").textContent = bdm || "BDM";

    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    function formatWeekRange(start) {
      const end = new Date(start);
      end.setDate(start.getDate() + 4);
      return `${formatDate(start)} to ${formatDate(end)}`;
    }

    function changeWeek(offset) {
      currentMonday.setDate(currentMonday.getDate() + offset);
      renderWeek();
    }

    async function renderWeek() {
      document.getElementById("weekRange").textContent = formatWeekRange(currentMonday);
      const container = document.getElementById("daysContainer");
      container.innerHTML = "";
      const calls = await fetch(apiURL).then(res => res.json());
      const visits = JSON.parse(localStorage.getItem("visitLogs") || "[]");

      for (let i = 0; i < 5; i++) {
        const day = new Date(currentMonday);
        day.setDate(day.getDate() + i);
        const iso = formatDate(day);

        const col = document.createElement("div");
        col.className = "day-column";
        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = day.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
        col.appendChild(header);

        for (let j = 1; j <= 20; j++) {
          const slot = document.createElement("div");
          slot.className = "slot";

          const call = calls.find(c => c.Date === iso && c.Order === String(j) && c.BDM === bdm && c.Status !== "Deleted");
          const done = visits.some(v => v["Customer Name"] === call?.["Customer Name"] && v.Date === iso);

          if (call) {
            slot.innerHTML = `<strong>${call["Customer Name"]}</strong><br/>${call["Key Account Group"]}<br/>${call.Grade}`;
            if (done) slot.classList.add("completed");
            const btn = document.createElement("button");
            btn.className = "add-btn";
            btn.textContent = "Start Call";
            btn.onclick = () => {
              localStorage.setItem("selectedCustomer", JSON.stringify(call));
              window.location.href = "visit.html";
            };
            slot.appendChild(btn);
          } else {
            const btn = document.createElement("button");
            btn.className = "add-btn";
            btn.textContent = "Add Visit";
            btn.onclick = () => openAddCall(iso, j);
            slot.appendChild(btn);
          }
          col.appendChild(slot);
        }
        container.appendChild(col);
      }
    }

    async function openAddCall(date, order) {
      const modal = document.createElement("div");
      modal.style.position = "fixed";
      modal.style.top = "0";
      modal.style.left = "0";
      modal.style.width = "100vw";
      modal.style.height = "100vh";
      modal.style.background = "rgba(0,0,0,0.6)";
      modal.style.display = "flex";
      modal.style.justifyContent = "center";
      modal.style.alignItems = "center";

      const box = document.createElement("div");
      box.style.background = "white";
      box.style.padding = "1rem";
      box.style.borderRadius = "10px";
      box.style.width = "90%";
      box.style.maxWidth = "500px";
      box.style.maxHeight = "80vh";
      box.style.overflowY = "auto";

      const title = document.createElement("h2");
      title.textContent = `Select Store for ${date}`;
      box.appendChild(title);

      const input = document.createElement("input");
      input.placeholder = "Search store...";
      input.style.width = "100%";
      input.style.marginBottom = "10px";
      box.appendChild(input);

      const storeList = document.createElement("div");
      box.appendChild(storeList);

      const data = await fetch(customerAPI).then(r => r.json());
      const calls = await fetch(apiURL).then(r => r.json());

      const plannedNames = calls.filter(c => c.Date === date).map(c => c["Customer Name"]);
      const myStores = data.filter(d => d.BDM === bdm && !plannedNames.includes(d["Customer Name"]));

      function renderStores(filter = "") {
        storeList.innerHTML = "";
        myStores.filter(s => s["Customer Name"].toLowerCase().includes(filter.toLowerCase())).forEach(s => {
          const btn = document.createElement("button");
          btn.className = "add-btn";
          btn.textContent = s["Customer Name"];
          btn.onclick = async () => {
            await fetch(apiURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                data: [{
                  "Customer Name": s["Customer Name"],
                  "Date": date,
                  "Order": String(order),
                  "Grade": s.Grade,
                  "Key Account Group": s["Key Account Group"],
                  "BDM": bdm,
                  "Status": "Planned"
                }]
              })
            });
            modal.remove();
            renderWeek();
          };
          storeList.appendChild(btn);
        });
      }

      input.oninput = () => renderStores(input.value);
      renderStores();
      modal.appendChild(box);
      document.body.appendChild(modal);
    }

    renderWeek();
  </script></body>
</html><div class="week-header">
  <h2 id="weekRange"></h2>
  <div class="week-nav">
    <button onclick="changeWeek(-1)">Previous Week</button>
    <button onclick="changeWeek(1)">Next Week</button>
  </div>
</div>

<div class="week-container" id="calendarContainer">
  <!-- Days and slots will be generated here dynamically -->
</div>

<!-- Add Visit Modal -->
<div id="addVisitModal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeAddVisitModal()">&times;</span>
    <h2>Select Store(s) to Add</h2>
    <input type="text" id="storeSearch" placeholder="Search stores..." oninput="filterStores()" />
    <div id="storeListContainer"></div>
    <button onclick="confirmAddVisits()">Add Selected Visits</button>
  </div>
</div>

<footer>
  <button class="footer-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
  <button class="footer-btn" onclick="location.href='visit.html'">Visit Log</button>
</footer><script>
let currentWeekStart = getMonday(new Date());
let selectedDate = null;
let allStores = [];
const calendarApi = "https://sheetdb.io/api/v1/9envyaeemiz9h"; // Journey Planner API
const customerApi = "https://sheetdb.io/api/v1/8ba1eug88u4y1"; // Store Master API
const loggedInBDM = localStorage.getItem("username");

function getMonday(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(d.setDate(diff));
}

function changeWeek(direction) {
  currentWeekStart.setDate(currentWeekStart.getDate() + direction * 7);
  loadWeek();
}

function formatDate(date) {
  return date.toISOString().split('T')[0];
}

function loadWeek() {
  const weekRange = document.getElementById("weekRange");
  const monday = new Date(currentWeekStart);
  const friday = new Date(monday);
  friday.setDate(monday.getDate() + 4);
  weekRange.textContent = `${monday.toLocaleDateString()} → ${friday.toLocaleDateString()}`;

  document.getElementById("calendarContainer").innerHTML = "";

  for (let i = 0; i < 5; i++) {
    const day = new Date(monday);
    day.setDate(monday.getDate() + i);

    const daySection = document.createElement("div");
    daySection.classList.add("day-column");

    const dayHeader = document.createElement("h3");
    dayHeader.textContent = day.toLocaleDateString('en-AU', { weekday: 'long', month: 'short', day: 'numeric' });
    daySection.appendChild(dayHeader);

    for (let slot = 1; slot <= 20; slot++) {
      const slotDiv = document.createElement("div");
      slotDiv.classList.add("slot");
      slotDiv.innerHTML = `<button onclick="openAddVisit('${formatDate(day)}', ${slot})">Add Visit</button>`;
      slotDiv.dataset.date = formatDate(day);
      slotDiv.dataset.slot = slot;
      daySection.appendChild(slotDiv);
    }
    document.getElementById("calendarContainer").appendChild(daySection);
  }

  loadScheduledCalls();
}

function openAddVisit(date, slot) {
  selectedDate = { date, slot };
  document.getElementById("storeSearch").value = "";
  filterStores();
  document.getElementById("addVisitModal").classList.remove("hidden");
}

function closeAddVisitModal() {
  document.getElementById("addVisitModal").classList.add("hidden");
}

function confirmAddVisits() {
  const selectedStores = Array.from(document.querySelectorAll(".store-checkbox:checked")).map(cb => cb.value);
  if (selectedStores.length === 0) {
    alert("Select at least one store");
    return;
  }

  Promise.all(selectedStores.map((storeName, index) => {
    return fetch(calendarApi, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        data: {
          "Customer Name": storeName,
          "Date": selectedDate.date,
          "Order": selectedDate.slot + index,
          "BDM": loggedInBDM,
          "Status": "Planned"
        }
      })
    });
  })).then(() => {
    closeAddVisitModal();
    loadWeek();
  });
}

function filterStores() {
  const search = document.getElementById("storeSearch").value.toLowerCase();
  const listContainer = document.getElementById("storeListContainer");

  listContainer.innerHTML = allStores
    .filter(store => store["BDM"] === loggedInBDM && (!search || store["Customer Name"].toLowerCase().includes(search)))
    .map(store => `<div><label><input type="checkbox" class="store-checkbox" value="${store["Customer Name"]}"> ${store["Customer Name"]}</label></div>`)
    .join('');
}

function loadScheduledCalls() {
  fetch(calendarApi)
    .then(res => res.json())
    .then(data => {
      data
        .filter(call => call["BDM"] === loggedInBDM && call["Status"] !== "Deleted")
        .forEach(call => {
          const slot = document.querySelector(`.slot[data-date="${call["Date"]}"][data-slot="${call["Order"]}"]`);
          if (slot) {
            slot.innerHTML = `
              <div class="call-tile ${call["Status"] === "Completed" ? 'completed' : ''}">
                <strong>${call["Customer Name"]}</strong><br>
                <small>${call["Key Account Group"] || ""} | ${call["Grade"] || ""}</small><br>
                <button onclick="startVisit('${call["Customer Name"]}')">Start Visit</button>
              </div>`;
          }
        });
    });
}

function startVisit(storeName) {
  localStorage.setItem("selectedCustomerName", storeName);
  window.location.href = "visit.html";
}

function fetchStores() {
  fetch(customerApi)
    .then(res => res.json())
    .then(data => {
      allStores = data;
    });
}

window.onload = function() {
  fetchStores();
  loadWeek();
};
</script><style>
#calendarContainer {
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding: 10px;
  margin-top: 10px;
  height: calc(100vh - 220px); /* full screen minus headers/footers */
  box-sizing: border-box;
}

.day-column {
  flex: 0 0 20%;
  background: #f9f9f9;
  margin: 0 5px;
  padding: 10px;
  border-radius: 8px;
  min-width: 220px;
}

.day-column h3 {
  text-align: center;
  color: #2563eb;
  margin-bottom: 10px;
}

.slot {
  background: #eef3fd;
  border: 1px dashed #ccc;
  padding: 10px;
  margin-bottom: 8px;
  border-radius: 6px;
  text-align: center;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.call-tile {
  background-color: #2563eb;
  color: white;
  padding: 10px;
  border-radius: 6px;
  font-size: 0.9rem;
  text-align: center;
}

.call-tile.completed {
  background-color: #16a34a; /* green once visit completed */
}

.call-tile button {
  margin-top: 5px;
  padding: 6px 12px;
  font-size: 0.8rem;
  background: white;
  color: #2563eb;
  border-radius: 20px;
  border: none;
  cursor: pointer;
}

.call-tile button:hover {
  background: #cbd5e1;
}

.modal {
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 8px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  z-index: 2000;
  width: 90%;
  max-width: 400px;
  padding: 20px;
}

.modal h3 {
  text-align: center;
  color: #2563eb;
}

.modal input[type="text"] {
  width: 100%;
  padding: 8px;
  margin: 10px 0;
  box-sizing: border-box;
}

.modal .store-list {
  max-height: 300px;
  overflow-y: auto;
  margin-top: 10px;
  text-align: left;
}

.hidden {
  display: none;
}

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #cfe2ff;
  padding: 10px 0;
  display: flex;
  justify-content: space-around;
  border-top: 2px solid #ccc;
  z-index: 999;
}

.footer-btn {
  background-color: #2563eb;
  color: white;
  border: none;
  padding: 12px 20px;
  font-size: 1.1rem;
  border-radius: 30px;
  cursor: pointer;
  transition: background-color 0.3s ease-in-out;
}

.footer-btn:hover {
  background-color: #1e40af;
}
</style>
