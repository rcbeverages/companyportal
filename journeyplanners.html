<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Journey Planner - RC Beverages</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Journey Planner</h1>
  </header>
  <div class="welcome-message">Welcome <span id="username"></span></div>
  <div class="content">
    <div class="navigation">
      <button onclick="previousWeek()">Previous Week</button>
      <span class="week-header" id="weekRange"></span>
      <button onclick="nextWeek()">Next Week</button>
    </div>
    <div class="calendar" id="calendar"></div>
  </div>  <div id="addVisitModal">
    <h3>Select Store</h3>
    <input type="text" id="storeSearch" placeholder="Search stores..." oninput="filterStores()" />
    <div id="storeList"></div>
    <button onclick="confirmAddVisit()">Add Visit</button>
  </div>  <footer>
    <button class="footer-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
    <button class="footer-btn" onclick="location.href='visit.html'">Visit Log</button>
    <button class="footer-btn" onclick="location.href='reminders.html'">Reminders</button>
    <button class="footer-btn" onclick="location.href='portfolio.html'">Portfolio</button>
  </footer>  <script>
    const sheetAPI = "https://sheetdb.io/api/v1/9envyaeemiz9h";
    const masterAPI = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
    let username = localStorage.getItem('username') || 'User';
    document.getElementById("username").innerText = username;

    let currentMonday = getMonday(new Date());
    let selectedDay = '';
    let storeData = [];
    let calendarData = [];

    function getMonday(d) {
      d = new Date(d);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function formatDate(d) {
      return d.toISOString().split('T')[0];
    }

    function loadCalendar() {
      fetch(sheetAPI)
        .then(res => res.json())
        .then(data => {
          calendarData = data.filter(c => c.BDM === username);
          renderCalendar();
        });
    }

    function renderCalendar() {
      const weekDates = [];
      for (let i = 0; i < 5; i++) {
        let d = new Date(currentMonday);
        d.setDate(d.getDate() + i);
        weekDates.push(d);
      }

      document.getElementById('weekRange').innerText = `${formatDate(weekDates[0])} → ${formatDate(weekDates[4])}`;
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      weekDates.forEach(date => {
        const column = document.createElement('div');
        column.className = 'day-column';
        const header = document.createElement('div');
        header.className = 'day-header';
        header.innerText = date.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'short' });
        column.appendChild(header);
        const slots = document.createElement('div');
        slots.className = 'slots';

        const dayCalls = calendarData.filter(c => c.Date === formatDate(date));
        for (let i = 1; i <= 20; i++) {
          const slot = document.createElement('div');
          slot.className = 'slot';
          const call = dayCalls.find(c => c.Order == i);
          if (call) {
            slot.innerHTML = `${call["Customer Name"]} ${call.Status === "Completed" ? "✅" : ""}`;
            slot.onclick = () => {
              localStorage.setItem("selectedCustomer", JSON.stringify(call));
              window.location.href = "visit.html";
            };
          } else {
            slot.innerHTML = `<button onclick=\"openAddVisit('${formatDate(date)}',${i})\">Add Visit</button>`;
          }
          slots.appendChild(slot);
        }
        column.appendChild(slots);
        calendar.appendChild(column);
      });
    }

    function previousWeek() {
      currentMonday.setDate(currentMonday.getDate() - 7);
      loadCalendar();
    }

    function nextWeek() {
      currentMonday.setDate(currentMonday.getDate() + 7);
      loadCalendar();
    }

    function openAddVisit(day, slot) {
      selectedDay = { day, slot };
      document.getElementById("addVisitModal").style.display = "block";
      fetch(masterAPI)
        .then(res => res.json())
        .then(data => {
          storeData = data.filter(s => s.BDM === username);
          filterStores();
        });
    }

    function filterStores() {
      const keyword = document.getElementById("storeSearch").value.toLowerCase();
      const list = document.getElementById("storeList");
      list.innerHTML = '';
      const plannedStores = calendarData.filter(c => c.Date === selectedDay.day).map(c => c["Customer Name"]);
      storeData
        .filter(s => !plannedStores.includes(s["Customer Name"]) && s["Customer Name"].toLowerCase().includes(keyword))
        .forEach(store => {
          const btn = document.createElement('button');
          btn.innerText = store["Customer Name"];
          btn.onclick = () => addVisit(store["Customer Name"]);
          list.appendChild(btn);
        });
    }

    function addVisit(name) {
      const payload = {
        "Date": selectedDay.day,
        "Customer Name": name,
        "BDM": username,
        "Order": selectedDay.slot,
        "Status": "Planned"
      };

      fetch(sheetAPI, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: payload })
      }).then(() => {
        document.getElementById("addVisitModal").style.display = "none";
        loadCalendar();
      });
    }

    function confirmAddVisit() {}
    window.onload = loadCalendar;
  </script></body>
</html>
