function toggleSection(id) {
  document.getElementById(id).classList.toggle("hidden");
}

function loadCustomerDetails() {
  const fields = [
    "Customer Name", "Sub Owner Group", "Key Account Group", "Grade",
    "Store Type", "Segment", "Contact Name", "Phone", "Email",
    "Address", "Suburb", "State", "Postcode", "BDM"
  ];
  document.getElementById("customerDetails").innerHTML = fields.map(k => 
    `<strong>${k}:</strong> ${customer[k] || "â€”"}<br/>`
  ).join('');
  
  document.getElementById("editCustomerName").value = customer["Customer Name"] || "";
  document.getElementById("editSubOwnerGroup").value = customer["Sub Owner Group"] || "";
  document.getElementById("editKeyAccountGroup").value = customer["Key Account Group"] || "";
  document.getElementById("editGrade").value = customer["Grade"] || "";
  document.getElementById("editStoreType").value = customer["Store Type"] || "";
  document.getElementById("editSegment").value = customer["Segment"] || "";
  document.getElementById("editBDM").value = customer["BDM"] || "";
  document.getElementById("editContactName").value = customer["Contact Name"] || "";
  document.getElementById("editPhone").value = customer["Phone"] || "";
  document.getElementById("editEmail").value = customer["Email"] || "";
  document.getElementById("editAddress").value = customer["Address"] || "";
  document.getElementById("editSuburb").value = customer["Suburb"] || "";
  document.getElementById("editState").value = customer["State"] || "";
  document.getElementById("editPostcode").value = customer["Postcode"] || "";
}

function saveEverything() {
  const now = new Date();
  
  const visitLog = {
    "Date": now.toISOString().split('T')[0],
    "Timestamp": now.toLocaleString(),
    "Customer Name": customer["Customer Name"],
    "BDM": customer["BDM"],
    "Visit Reason": document.getElementById("visitReason").value,
    "Outcome": document.getElementById("visitOutcome").value,
    "Notes": document.getElementById("visitNotes").value.trim()
  };
  
  const reminder = {
    "Date to Email": document.getElementById("reminderDate").value,
    "Customer Name": customer["Customer Name"],
    "BDM": customer["BDM"],
    "Comments": document.getElementById("reminderComments").value
  };
  
  const asset = {
    "Customer Name": customer["Customer Name"],
    "Asset Type": document.getElementById("assetType").value,
    "Asset Tag Code": document.getElementById("assetTag").value,
    "Agreement": document.getElementById("assetAgreement").value,
    "Asset Comments": document.getElementById("assetComments").value
  };

  Promise.all([
    fetch(visitLogAPI, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: visitLog })
    }),
    fetch(reminderAPI, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: reminder })
    }),
    fetch(assetAPI, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: asset })
    })
  ])
  .then(() => markCallCompleted(customer["Customer Name"], visitLog["Date"]))
  .then(() => {
    alert('Save/End Call Completed');
    window.location.href = "dashboard.html";
  })
  .catch(() => alert('Error saving visit details.'));
}

function markCallCompleted(customerName, date) {
  return fetch(`https://sheetdb.io/api/v1/9envyaeemiz9h/search?Customer%20Name=${encodeURIComponent(customerName)}&Date=${encodeURIComponent(date)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        const id = data[0].id;
        return fetch(`https://sheetdb.io/api/v1/9envyaeemiz9h/id/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: { "Status": "Completed" } })
        });
      }
    });
}

function loadStoreRange() {
  fetch(storeRangeAPI)
    .then(res => res.json())
    .then(data => {
      const storeRange = data.find(d => d["Customer Name"] === customer["Customer Name"]);
      const list = document.getElementById("storeRangeList");
      if (!storeRange) {
        list.innerHTML = "No range available.";
        return;
      }
      list.innerHTML = Object.entries(storeRange).map(([k, v]) => 
        `<div><strong>${k}:</strong> ${v}</div>`
      ).join('');
    });
}

function loadPastNotes() {
  fetch(visitLogAPI)
    .then(res => res.json())
    .then(data => {
      const notes = data
        .filter(entry => entry["Customer Name"] === customer["Customer Name"])
        .sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp))
        .slice(0, 5)
        .map(entry => `<div><strong>${entry.Timestamp}:</strong><br>${entry.Notes}</div>`)
        .join('');
      document.getElementById("pastNotes").innerHTML = notes || "No notes found.";
    });
}

window.onload = function() {
  loadCustomerDetails();
  loadStoreRange();
  loadPastNotes();
};
</script>

</body>
</html>


