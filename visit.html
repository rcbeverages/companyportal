<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visit Log</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .edit-btn {
      margin: 5px;
      background-color: #0057b7;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
    }
    .edit-btn:hover {
      background-color: #0041a3;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-sizing: border-box;
    }
    .modal-content h2 {
      margin-bottom: 20px;
    }
    .modal-content .form-group {
      margin-bottom: 15px;
    }
    .modal-content label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .modal-content button {
      margin-top: 20px;
      width: 100%;
      background-color: #0057b7;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
    }
    .modal-content button:hover {
      background-color: #0041a3;
    }
    .close-btn {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #0057b7;
    }
  </style>
</head>
<body>
  <div class="card">
    <button class="edit-btn" onclick="openStoreModal()">Edit Store</button>
    <button class="edit-btn" onclick="openContactModal()">Edit Contact</button>
    <button class="edit-btn" onclick="openAddressModal()">Edit Address</button>
  </div>

  <!-- Edit Store Modal -->
  <div id="storeModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('storeModal')">&times;</span>
      <h2>Edit Store Info</h2>
      <div class="form-group"><label>Customer Name</label><input id="editCustomerName" required /></div>
      <div class="form-group"><label>Sub Owner Group</label><select id="editSubOwnerGroup"></select></div>
      <div class="form-group"><label>Key Account Group</label><select id="editKeyAccountGroup"></select></div>
      <div class="form-group"><label>Grade</label><select id="editGrade"></select></div>
      <div class="form-group"><label>Store Type</label><select id="editStoreType"></select></div>
      <div class="form-group"><label>Segment</label><select id="editSegment"></select></div>
      <div class="form-group"><label>BDM</label><select id="editBDM"></select></div>
      <button onclick="saveStoreInfo()">Save Changes</button>
    </div>
  </div>

  <!-- Edit Contact Modal -->
  <div id="contactModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('contactModal')">&times;</span>
      <h2>Edit Contact Info</h2>
      <div class="form-group"><label>Contact Name</label><input id="editContactName" /></div>
      <div class="form-group"><label>Phone</label><input id="editPhone" /></div>
      <div class="form-group"><label>Email</label><input id="editEmail" /></div>
      <button onclick="saveContactInfo()">Save Changes</button>
    </div>
  </div>

  <!-- Edit Address Modal -->
  <div id="addressModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('addressModal')">&times;</span>
      <h2>Edit Address</h2>
      <div class="form-group"><label>Address</label><input id="editAddress" /></div>
      <div class="form-group"><label>Suburb</label><input id="editSuburb" /></div>
      <div class="form-group"><label>State</label><input id="editState" /></div>
      <div class="form-group"><label>Postcode</label><input id="editPostcode" /></div>
      <button onclick="saveAddressInfo()">Save Changes</button>
    </div>
  </div>

  <script>
    const sheetUrl = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
    const customerSheet = sheetUrl;
    const selectedCustomer = JSON.parse(localStorage.getItem("selectedCustomer"));
    let customer = {};

    if (selectedCustomer) {
      loadCustomerDetails(selectedCustomer["Customer Name"]);
    } else {
      window.location.href = "dashboard.html";
    }

    function loadCustomerDetails(customerName) {
      fetch(`${customerSheet}?Customer%20Name=${encodeURIComponent(customerName)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            customer = data[0];
          }
        });
    }

    function openStoreModal() {
      populateStoreFields();
      document.getElementById("storeModal").style.display = "block";
    }

    function openContactModal() {
      populateContactFields();
      document.getElementById("contactModal").style.display = "block";
    }

    function openAddressModal() {
      populateAddressFields();
      document.getElementById("addressModal").style.display = "block";
    }

    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    function populateDropdown(selectId, columnName, selectedValue) {
      fetch(`${customerSheet}?limit=1000`)
        .then(res => res.json())
        .then(data => {
          const uniqueOptions = [...new Set(data.map(row => row[columnName]).filter(Boolean))];
          const select = document.getElementById(selectId);
          select.innerHTML = "";
          uniqueOptions.sort().forEach(option => {
            const opt = document.createElement("option");
            opt.value = option;
            opt.textContent = option;
            if (option === selectedValue) opt.selected = true;
            select.appendChild(opt);
          });
        });
    }

    function populateStoreFields() {
      document.getElementById("editCustomerName").value = customer["Customer Name"] || "";
      populateDropdown("editSubOwnerGroup", "Sub Owner Group", customer["Sub Owner Group"]);
      populateDropdown("editKeyAccountGroup", "Key Account Group", customer["Key Account Group"]);
      populateDropdown("editGrade", "Grade", customer["Grade"]);
      populateDropdown("editStoreType", "Store Type", customer["Store Type"]);
      populateDropdown("editSegment", "Segment", customer["Segment"]);
      populateDropdown("editBDM", "BDM", customer["BDM"]);
    }

    function populateContactFields() {
      document.getElementById("editContactName").value = customer["Contact Name"] || "";
      document.getElementById("editPhone").value = customer["Phone"] || "";
      document.getElementById("editEmail").value = customer["Email"] || "";
    }

    function populateAddressFields() {
      document.getElementById("editAddress").value = customer["Address"] || "";
      document.getElementById("editSuburb").value = customer["Suburb"] || "";
      document.getElementById("editState").value = customer["State"] || "";
      document.getElementById("editPostcode").value = customer["Postcode"] || "";
    }

    function saveCustomerFields(updatedFields) {
      fetch(`${sheetUrl}/Customer Name/${encodeURIComponent(customer["Customer Name"])}", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: updatedFields })
      }).then(() => {
        window.location.reload();
      });
    }

    function saveStoreInfo() {
      const updated = {
        "Customer Name": document.getElementById("editCustomerName").value.trim(),
        "Sub Owner Group": document.getElementById("editSubOwnerGroup").value,
        "Key Account Group": document.getElementById("editKeyAccountGroup").value,
        "Grade": document.getElementById("editGrade").value,
        "Store Type": document.getElementById("editStoreType").value,
        "Segment": document.getElementById("editSegment").value,
        "BDM": document.getElementById("editBDM").value
      };
      saveCustomerFields(updated);
      closeModal("storeModal");
    }

    function saveContactInfo() {
      const updated = {
        "Contact Name": document.getElementById("editContactName").value.trim(),
        "Phone": document.getElementById("editPhone").value.trim(),
        "Email": document.getElementById("editEmail").value.trim()
      };
      saveCustomerFields(updated);
      closeModal("contactModal");
    }

    function saveAddressInfo() {
      const updated = {
        "Address": document.getElementById("editAddress").value.trim(),
        "Suburb": document.getElementById("editSuburb").value.trim(),
        "State": document.getElementById("editState").value.trim(),
        "Postcode": document.getElementById("editPostcode").value.trim()
      };
      saveCustomerFields(updated);
      closeModal("addressModal");
    }
  </script>
</body>
</html>
