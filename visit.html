<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visit Log - RC Beverages</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>Visit Log</h1>
</header>

<div class="welcome-bar">
  Welcome <span id="username"></span>
</div>

<div class="content-container">

  <!-- Customer Details (Static Section) -->
  <div class="card">
    <h2>Customer Details</h2>
    <div id="detailsContent">
      <p><strong>Customer Name:</strong> <span id="custName">Loading...</span></p>
      <p><strong>Sub Owner Group:</strong> <span id="subOwnerGroup">Loading...</span></p>
      <p><strong>Key Account Group:</strong> <span id="keyAccountGroup">Loading...</span></p>
      <p><strong>Grade:</strong> <span id="grade">Loading...</span></p>
      <p><strong>Store Type:</strong> <span id="storeType">Loading...</span></p>
      <p><strong>Segment:</strong> <span id="segment">Loading...</span></p>
      <p><strong>Contact Name:</strong> <span id="contactNameView">Loading...</span></p>
      <p><strong>Phone:</strong> <span id="contactPhoneView">Loading...</span></p>
      <p><strong>Email:</strong> <span id="contactEmailView">Loading...</span></p>
      <p><strong>Address:</strong> <span id="address">Loading...</span></p>
      <p><strong>Suburb:</strong> <span id="suburb">Loading...</span></p>
      <p><strong>State:</strong> <span id="state">Loading...</span></p>
      <p><strong>Postcode:</strong> <span id="postcode">Loading...</span></p>
      <p><strong>BDM:</strong> <span id="bdmView">Loading...</span></p>
    </div>
  </div>

  <!-- Log Visit (Static Section) -->
  <div class="card">
    <h2>Log Visit</h2>
    <div class="form-group">
      <label>Visit Reason</label>
      <select id="reason">
        <option>Planned Visit</option>
        <option>Ranging Update</option>
        <option>Tasting</option>
      </select>
    </div>
    <div class="form-group">
      <label>Outcome</label>
      <select id="outcome">
        <option>Positive</option>
        <option>Neutral</option>
        <option>Negative</option>
        <option>Follow-Up Required</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="notes" rows="4"></textarea>
    </div>
  </div>
  <!-- Edit Contact Details -->
  <div class="card">
    <button class="collapsible" onclick="toggleSection('contactForm')">Edit Contact Details</button>
    <div id="contactForm" class="hidden">
      <div class="form-group">
        <label>Contact Name</label>
        <input id="contactNameEdit" />
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input id="contactPhoneEdit" />
      </div>
      <div class="form-group">
        <label>Email</label>
        <input id="contactEmailEdit" />
      </div>
    </div>
  </div>

  <!-- Edit Address -->
  <div class="card">
    <button class="collapsible" onclick="toggleSection('addressForm')">Edit Address</button>
    <div id="addressForm" class="hidden">
      <div class="form-group">
        <label>Address</label>
        <input id="addressEdit" />
      </div>
      <div class="form-group">
        <label>Suburb</label>
        <input id="suburbEdit" />
      </div>
      <div class="form-group">
        <label>State</label>
        <input id="stateEdit" />
      </div>
      <div class="form-group">
        <label>Postcode</label>
        <input id="postcodeEdit" />
      </div>
    </div>
  </div>

  <!-- Edit Classification -->
  <div class="card">
    <button class="collapsible" onclick="toggleSection('classificationForm')">Edit Classification</button>
    <div id="classificationForm" class="hidden">
      <div class="form-group">
        <label>Sub Owner Group</label>
        <select id="subOwnerGroupEdit"></select>
      </div>
      <div class="form-group">
        <label>Key Account Group</label>
        <select id="keyAccountGroupEdit"></select>
      </div>
      <div class="form-group">
        <label>Grade</label>
        <select id="gradeEdit"></select>
      </div>
      <div class="form-group">
        <label>Store Type</label>
        <select id="storeTypeEdit"></select>
      </div>
      <div class="form-group">
        <label>Segment</label>
        <select id="segmentEdit"></select>
      </div>
      <div class="form-group">
        <label>BDM Assignment</label>
        <select id="bdmEdit"></select>
      </div>
    </div>
  </div>

  <!-- Store Range -->
  <div class="card">
    <button class="collapsible" onclick="toggleSection('storeRange')">Store Range</button>
    <div id="storeRange" class="hidden">
      <div id="rangeContainer">Loading store range...</div>
    </div>
  </div>

  <!-- Preorders -->
  <div class="card">
    <button class="collapsible" onclick="toggleSection('preorderForm')">Preorders</button>
    <div id="preorderForm" class="hidden">
      <div id="preorderContainer">Loading preorders...</div>
    </div>
  </div>

  <!-- Asset Management -->
  <div class="card">
    <button class="collapsible" onclick="toggleSection('assetForm')">Asset Management</button>
    <div id="assetForm" class="hidden">
      <div class="form-group">
        <label>Asset Type</label>
        <input id="assetType" />
      </div>
      <div class="form-group">
        <label>Asset Tag Code</label>
        <input id="assetTag" />
      </div>
      <div class="form-group">
        <label>Agreement</label>
        <input id="assetAgreement" />
      </div>
      <div class="form-group">
        <label>Comments</label>
        <textarea id="assetComments" rows="4"></textarea>
      </div>
      <div id="existingAssets">Loading existing assets...</div>
    </div>
  </div>

  <!-- Email Reminder -->
  <div class="card">
    <button class="collapsible" onclick="toggleSection('emailReminder')">Email Reminder</button>
    <div id="emailReminder" class="hidden">
      <div class="form-group">
        <label>Date to Email</label>
        <input type="date" id="reminderDate" />
      </div>
      <div class="form-group">
        <label>Reminder Comments</label>
        <textarea id="reminderNotes" rows="2"></textarea>
      </div>
    </div>
  </div>
  <!-- Past Visit Notes -->
  <div class="card">
    <h2>Previous Visit Notes</h2>
    <div id="pastNotes">Loading previous notes...</div>
  </div>

  <!-- Current Promos -->
  <div class="card" id="promoSection" style="display: none;">
    <h2>Current Promos</h2>
    <div id="promoList">Loading current promos...</div>
  </div>

  <!-- Save Button -->
  <div class="card action-buttons">
    <button onclick="saveEverything()">Save / End Call</button>
  </div>

</div> <!-- Close .form-container -->

<!-- Footer -->
<footer>
  <button class="footer-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
  <button class="footer-btn" onclick="location.href='journeyplanner.html'">Journey Planner</button>
  <button class="footer-btn" onclick="location.href='reminders.html'">Reminders</button>
  <button class="footer-btn" onclick="location.href='portfolio.html'">Portfolio</button>
</footer>
<script>
// Toggle collapsible sections
function toggleSection(id) {
  const section = document.getElementById(id);
  section.classList.toggle('hidden');
}

// Show popup confirmation
function showPopup(message) {
  alert(message);
}
  const customerSheet = "https://sheetdb.io/api/v1/your-sheetdb-endpoint"; // <-- update this

function loadCustomerDetails(customerName) {
  fetch(`${customerSheet}?Customer%20Name=${encodeURIComponent(customerName)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        const customer = data[0];

        document.getElementById("custName").textContent = customer["Customer Name"] || "";
        document.getElementById("subOwnerGroup").textContent = customer["Sub Owner Group"] || "";
        document.getElementById("keyAccountGroup").textContent = customer["Key Account Group"] || "";
        document.getElementById("grade").textContent = customer["Grade"] || "";
        document.getElementById("storeType").textContent = customer["Store Type"] || "";
        document.getElementById("segment").textContent = customer["Segment"] || "";
        document.getElementById("contactNameView").textContent = customer["Contact Name"] || "";
        document.getElementById("contactPhoneView").textContent = customer["Phone"] || "";
        document.getElementById("contactEmailView").textContent = customer["Email"] || "";
        document.getElementById("address").textContent = customer["Address"] || "";
        document.getElementById("suburb").textContent = customer["Suburb"] || "";
        document.getElementById("state").textContent = customer["State"] || "";
        document.getElementById("postcode").textContent = customer["Postcode"] || "";
        document.getElementById("bdmView").textContent = customer["BDM"] || "";
      }
    })
    .catch(err => console.error("Failed to load customer details", err));
}


// Save Everything Function
function saveEverything() {
  const now = new Date();

  const visitReason = document.getElementById("reason").value;
  const outcome = document.getElementById("outcome").value;
  const notes = document.getElementById("notes").value.trim();
  const shouldLogVisit = (visitReason === "Planned Visit" || visitReason === "Tasting") && notes !== "";

  const reminder = {
    "Date to Email": document.getElementById("reminderDate").value,
    "Customer Name": customer["Customer Name"],
    "BDM": customer["BDM"],
    "Comments": document.getElementById("reminderNotes").value
  };

  const assetType = document.getElementById("assetType").value.trim();
  const assetTag = document.getElementById("assetTag").value.trim();
  const agreement = document.getElementById("assetAgreement").value.trim();
  const comments = document.getElementById("assetComments").value.trim();
  const shouldSaveAsset = assetType && assetTag && agreement && comments;

  const asset = {
    "Customer Name": customer["Customer Name"],
    "Asset Type": assetType,
    "Asset Tag Code": assetTag,
    "Agreement": agreement,
    "Asset Comments": comments
  };

  const preorders = {
    "Customer Name": customer["Customer Name"],
    "QTY - Creamy Soda": document.getElementById("qtyCreamy")?.value || "",
    "QTY - Sarsaparilla": document.getElementById("qtySars")?.value || "",
    "QTY - Blueberry Rasp": document.getElementById("qtyBlue")?.value || "",
    "QTY - Portello": document.getElementById("qtyPortello")?.value || "",
    "QTY - LLB": document.getElementById("qtyLLB")?.value || "",
    "QTY - Rasp Lemonade": document.getElementById("qtyRaspLem")?.value || ""
  };

  const update = {
    "Contact Name": document.getElementById("contactNameEdit")?.value || "",
    "Phone": document.getElementById("contactPhoneEdit")?.value || "",
    "Email": document.getElementById("contactEmailEdit")?.value || "",
    "Address": document.getElementById("addressEdit")?.value || "",
    "Suburb": document.getElementById("suburbEdit")?.value || "",
    "State": document.getElementById("stateEdit")?.value || "",
    "Postcode": document.getElementById("postcodeEdit")?.value || "",
    "Sub Owner Group": document.getElementById("subOwnerGroupEdit")?.value || "",
    "Key Account Group": document.getElementById("keyAccountGroupEdit")?.value || "",
    "Grade": document.getElementById("gradeEdit")?.value || "",
    "Store Type": document.getElementById("storeTypeEdit")?.value || "",
    "Segment": document.getElementById("segmentEdit")?.value || "",
    "BDM": document.getElementById("bdmEdit")?.value || ""
  };

  fetch(`${sheetUrl}/Customer Name/${encodeURIComponent(customer["Customer Name"])}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ data: update })
  })
  .then(() => {
    if (shouldLogVisit) {
      const visit = {
        "Date": now.toISOString().split("T")[0],
        "Timestamp": now.toLocaleString(),
        "Customer Name": customer["Customer Name"],
        "BDM": customer["BDM"],
        "Visit Reason": visitReason,
        "Outcome": outcome,
        "Notes": notes,
        "Status": "Completed"
      };
      return fetch(visitLogSheet, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: visit })
      });
    }
  })
  .then(() => fetch(reminderSheet, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ data: reminder })
  }))
  .then(() => {
    if (shouldSaveAsset) {
      return fetch(assetSheet, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: asset })
      });
    }
  })
  .then(() =>
    fetch(`${preorderSheet}?Customer%20Name=${encodeURIComponent(customer["Customer Name"])}`)
      .then(res => res.json())
      .then(data => {
        const method = data.length ? "PATCH" : "POST";
        const url = data.length
          ? `${preorderSheet}/Customer%20Name/${encodeURIComponent(customer["Customer Name"])}`
          : preorderSheet;
        return fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: preorders })
        });
      })
  )
  .then(() => {
    showPopup("Save/End Call Completed");
    setTimeout(() => window.location.href = "dashboard.html", 1500);
  })
  .catch(() => alert("Something went wrong during save."));
}
</script>

</body>
</html>
