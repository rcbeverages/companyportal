<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RC Beverages Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Basic Body Styling */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      text-align: center;
      padding-top: 100px; /* Add padding to prevent content being hidden behind fixed header */
    }

    /* Fixed Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #0057b7;
      color: white;
      padding: 20px;
      text-align: center;
      z-index: 1000; /* Keeps the header on top */
    }

    /* Page Title Styling */
    h1 {
      margin: 0;
      font-size: 2.5rem;
    }

    /* Fixed Welcome Message */
    .welcome-message {
      position: fixed;
      top: 70px; /* Move the welcome message just below the header */
      left: 0;
      right: 0;
      background-color: #ffffff;
      color: #0057b7;
      padding: 15px;
      font-size: 2rem;
      margin-top: 10px;
      z-index: 999;
    }

    /* Button Container Layout */
    .button-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 2rem;
     padding: 6rem 0; /* Ensure the buttons are below the fixed header and welcome message */
}

    /* Button Styling */
    .btn {
      background-color: #2563eb;
      color: white;
      padding: 50px;
      font-size: 1.5rem;
      border-radius: 6px;
      border: none;
      text-decoration: none;
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 10px 0;
      cursor: pointer;
      transition: background-color 0.3s ease-in-out;
    }

    .btn:hover {
      background-color: #1e40af;
    }

    /* Footer Styling */
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #cfe2ff;
      padding: 10px 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 2px solid #ccc;
      z-index: 1000;
    }

    footer .footer-btn {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1.1rem;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s ease-in-out;
    }

    footer .footer-btn:hover {
      background-color: #1e40af;
    }

    /* Media Queries for Tablet and Mobile */
    @media screen and (max-width: 768px) {
      .btn {
        font-size: 1.2rem;
        padding: 20px;
      }
    }

    /* Media Queries for Mobile */
    @media screen and (max-width: 600px) {
      footer .footer-btn {
        font-size: 1rem;
        padding: 10px 15px;
      }
    }
  </style>
</head>

<body>
  <!-- Header Section with Page Title -->
  <header>
    <h1>Dashboard</h1>
  </header>

  <!-- Welcome Message Section -->
  <div class="welcome-message" id="welcome">
    <!-- Welcome message will be injected here -->
  </div>

  <!-- Button Container for Groups -->
  <div class="button-container" id="dashboard-sections">
    <!-- Buttons will be dynamically populated here -->
  </div>

  <footer>
    <button class="footer-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
    <button class="footer-btn" onclick="location.href='comms.html'">Communication</button>
    <button class="footer-btn" onclick="location.href='journeyplanners.html'">Journey Planner</button>
    <button class="footer-btn" onclick="location.href='reminders.html'">Reminders</button>
    <button class="footer-btn" onclick="location.href='portfolio.html'">Portfolio</button>
  </footer>
  
<div class="card">
  <h2>Customer Details</h2>
  <div id="detailsContent">Loading...</div>
</div>
window.onload = () => {
  const customer = JSON.parse(localStorage.getItem("selectedCustomer") || "{}");
  const fields = [
    "Customer Name", "Sub Owner Group", "Key Account Group", "Grade",
    "Store Type", "Segment", "Contact Name", "Phone", "Email",
    "Address", "Suburb", "State", "Postcode", "BDM"
  ];

  document.getElementById("detailsContent").innerHTML = fields.map(k =>
    `<strong>${k}:</strong> ${customer[k] || "—"}<br>`
  ).join('');
};
    
    <!-- Log Visit -->
<div class="card">
  <button class="static-header">Log Visit</button>
  <div id="logVisit" class="hidden">
    <div class="form-group"><label>Visit Reason</label>
      <select id="visitReason">
        <option>Planned Visit</option>
        <option>Ranging Update</option>
        <option>Tasting</option>
      </select>
    </div>
    <div class="form-group"><label>Outcome</label>
      <select id="visitOutcome">
        <option>Positive</option>
        <option>Neutral</option>
        <option>Negative</option>
        <option>Follow-Up Required</option>
      </select>
    </div>
    <div class="form-group"><label>Notes</label><textarea id="visitNotes" rows="3"></textarea></div>
  </div>
</div>
    
    <!-- Email Reminder -->
<div class="card">
  <button class="collapsible" onclick="toggleSection('emailReminder')">Reminders</button>
  <div id="emailReminder" class="hidden">
    <div class="form-group"><label>Date to Remind</label><input type="date" id="reminderDate" /></div>
    <div class="form-group"><label>Reminder Comments</label><textarea id="reminderComments" rows="2"></textarea></div>
  </div>
</div>

    <!-- Store Range -->
<div class="card">
  <button class="collapsible" onclick="toggleSection('storeRange')">Store Range</button>
  <div id="storeRange" class="hidden">
    <div id="storeRangeList">Loading store range...</div>
  </div>
</div>

<!-- Preorders -->
<div class="card">
  <button class="collapsible" onclick="toggleSection('preorderForm')">Preorders</button>
  <div id="preorderForm" class="hidden">
    <div id="preorderList">Loading preorder SKUs...</div>
  </div>
</div>

    <!-- Contact Details -->
<div class="card">
  <button class="collapsible" onclick="toggleSection('contactForm')">Edit Contact Details</button>
  <div id="contactForm" class="hidden">
    <div class="form-group"><label>Contact Name</label><input id="editContactName" /></div>
    <div class="form-group"><label>Phone</label><input id="editPhone" /></div>
    <div class="form-group"><label>Email</label><input id="editEmail" /></div>
  </div>
</div>

<!-- Address -->
<div class="card">
  <button class="collapsible" onclick="toggleSection('addressForm')">Edit Address</button>
  <div id="addressForm" class="hidden">
    <div class="form-group"><label>Address</label><input id="editAddress" /></div>
    <div class="form-group"><label>Suburb</label><input id="editSuburb" /></div>
    <div class="form-group"><label>State</label><input id="editState" /></div>
    <div class="form-group"><label>Postcode</label><input id="editPostcode" /></div>
  </div>
</div>

<!-- Classification -->
<div class="card">
  <button class="collapsible" onclick="toggleSection('classificationForm')">Edit Classification</button>
  <div id="classificationForm" class="hidden">
    <div class="form-group"><label>Sub Owner Group</label><input id="editSubOwnerGroup" /></div>
    <div class="form-group"><label>Key Account Group</label><input id="editKeyAccountGroup" /></div>
    <div class="form-group"><label>Grade</label><input id="editGrade" /></div>
    <div class="form-group"><label>Store Type</label><input id="editStoreType" /></div>
    <div class="form-group"><label>Segment</label><input id="editSegment" /></div>
    <div class="form-group"><label>BDM Assignment</label><input id="editBDM" /></div>
  </div>
</div>

<!-- Asset Management -->
<div class="card">
  <button class="collapsible" onclick="toggleSection('assetForm')">Asset Management</button>
  <div id="assetForm" class="hidden">
    <div class="form-group"><label>Asset Type</label><input id="assetType" /></div>
    <div class="form-group"><label>Asset Tag Code</label><input id="assetTag" /></div>
    <div class="form-group"><label>Agreement</label><input id="assetAgreement" /></div>
    <div class="form-group"><label>Comments</label><textarea id="assetComments" rows="4"></textarea></div>
    <div id="existingAssets" class="existing-assets">Loading existing assets...</div>
  </div>
</div>

<!-- Past Notes -->
<div class="card">
  <h2>Previous Visit Notes</h2>
  <div id="pastNotes">Loading notes...</div>
</div>

<!-- Current Promos -->
<div class="card" id="promoSection" style="display: none;">
  <h2>Current Promos</h2>
  <div id="promoList">Loading promos...</div>
</div>

<!-- Save Buttons -->
<div class="card action-buttons">
  <button onclick="saveEverything()">Save / End Call</button>
</div>

<script>
   const username = localStorage.getItem("username");
    const bdmMap = {
      rhincksman: "Ryan Hincksman",
      chawkins: "Chris Hawkins"
    };

    const bdmName = bdmMap[username];

    let customerCache = [];
    document.getElementById("welcome").textContent = `Welcome, ${bdmName}`;

const customer = JSON.parse(localStorage.getItem("selectedCustomer") || "{}");
const masterAPI = "https://sheetdb.io/api/v1/8ba1eug88u4y1"; // Customer Master
const visitLogAPI = "https://sheetdb.io/api/v1/3jn3pg6hok7hj"; // Visit Logs
const reminderAPI = "https://sheetdb.io/api/v1/lkhkbez8p8el9"; // Reminders
const assetAPI = "https://sheetdb.io/api/v1/8kwtvisrhm2zd"; // Assets
const storeRangeAPI = "https://sheetdb.io/api/v1/2p0phuvm9dz42"; // Store Range

function toggleSection(id) {
  document.getElementById(id).classList.toggle("hidden");
}

function loadCustomerDetails() {
  const fields = [
    "Customer Name", "Sub Owner Group", "Key Account Group", "Grade",
    "Store Type", "Segment", "Contact Name", "Phone", "Email",
    "Address", "Suburb", "State", "Postcode", "BDM"
  ];
  document.getElementById("customerDetails").innerHTML = fields.map(k => 
    `<strong>${k}:</strong> ${customer[k] || "—"}<br/>`
  ).join('');
  
  document.getElementById("editCustomerName").value = customer["Customer Name"] || "";
  document.getElementById("editSubOwnerGroup").value = customer["Sub Owner Group"] || "";
  document.getElementById("editKeyAccountGroup").value = customer["Key Account Group"] || "";
  document.getElementById("editGrade").value = customer["Grade"] || "";
  document.getElementById("editStoreType").value = customer["Store Type"] || "";
  document.getElementById("editSegment").value = customer["Segment"] || "";
  document.getElementById("editBDM").value = customer["BDM"] || "";
  document.getElementById("editContactName").value = customer["Contact Name"] || "";
  document.getElementById("editPhone").value = customer["Phone"] || "";
  document.getElementById("editEmail").value = customer["Email"] || "";
  document.getElementById("editAddress").value = customer["Address"] || "";
  document.getElementById("editSuburb").value = customer["Suburb"] || "";
  document.getElementById("editState").value = customer["State"] || "";
  document.getElementById("editPostcode").value = customer["Postcode"] || "";
}

function saveEverything() {
  const now = new Date();
  
  const visitLog = {
    "Date": now.toISOString().split('T')[0],
    "Timestamp": now.toLocaleString(),
    "Customer Name": customer["Customer Name"],
    "BDM": customer["BDM"],
    "Visit Reason": document.getElementById("visitReason").value,
    "Outcome": document.getElementById("visitOutcome").value,
    "Notes": document.getElementById("visitNotes").value.trim()
  };
  
  const reminder = {
    "Date to Email": document.getElementById("reminderDate").value,
    "Customer Name": customer["Customer Name"],
    "BDM": customer["BDM"],
    "Comments": document.getElementById("reminderComments").value
  };
  
  const asset = {
    "Customer Name": customer["Customer Name"],
    "Asset Type": document.getElementById("assetType").value,
    "Asset Tag Code": document.getElementById("assetTag").value,
    "Agreement": document.getElementById("assetAgreement").value,
    "Asset Comments": document.getElementById("assetComments").value
  };

  Promise.all([
    fetch(visitLogAPI, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: visitLog })
    }),
    fetch(reminderAPI, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: reminder })
    }),
    fetch(assetAPI, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: asset })
    })
  ])
  .then(() => markCallCompleted(customer["Customer Name"], visitLog["Date"]))
  .then(() => {
    alert('Save/End Call Completed');
    window.location.href = "dashboard.html";
  })
  .catch(() => alert('Error saving visit details.'));
}

function markCallCompleted(customerName, date) {
  return fetch(`https://sheetdb.io/api/v1/9envyaeemiz9h/search?Customer%20Name=${encodeURIComponent(customerName)}&Date=${encodeURIComponent(date)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        const id = data[0].id;
        return fetch(`https://sheetdb.io/api/v1/9envyaeemiz9h/id/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: { "Status": "Completed" } })
        });
      }
    });
}

function loadStoreRange() {
  fetch(storeRangeAPI)
    .then(res => res.json())
    .then(data => {
      const storeRange = data.find(d => d["Customer Name"] === customer["Customer Name"]);
      const list = document.getElementById("storeRangeList");
      if (!storeRange) {
        list.innerHTML = "No range available.";
        return;
      }
      list.innerHTML = Object.entries(storeRange).map(([k, v]) => 
        `<div><strong>${k}:</strong> ${v}</div>`
      ).join('');
    });
}

function loadPastNotes() {
  fetch(visitLogAPI)
    .then(res => res.json())
    .then(data => {
      const notes = data
        .filter(entry => entry["Customer Name"] === customer["Customer Name"])
        .sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp))
        .slice(0, 5)
        .map(entry => `<div><strong>${entry.Timestamp}:</strong><br>${entry.Notes}</div>`)
        .join('');
      document.getElementById("pastNotes").innerHTML = notes || "No notes found.";
    });
}

window.onload = function() {
  loadCustomerDetails();
  loadStoreRange();
  loadPastNotes();
};
</script>

</body>
</html>


