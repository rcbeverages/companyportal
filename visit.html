<body>

<!-- Header -->
<header>
  <h1>Visit Log</h1>
</header>

<!-- Welcome Message -->
<div class="welcome-message" id="welcome">
  <!-- Will be filled dynamically -->
</div>

<!-- Page Layout Start -->
<div class="page-layout">

  <!-- Left Column -->
  <div class="left-column">
    <h2>Customer Details</h2> <!-- Subheader -->

    <div class="card">
      <div id="detailsContent">
        <p><strong>Customer Name:</strong> <span id="custName">Loading...</span></p>
        <p><strong>Sub Owner Group:</strong> <span id="subOwnerGroup">Loading...</span></p>
        <p><strong>Key Account Group:</strong> <span id="keyAccountGroup">Loading...</span></p>
        <p><strong>Grade:</strong> <span id="grade">Loading...</span></p>
        <p><strong>Store Type:</strong> <span id="storeType">Loading...</span></p>
        <p><strong>Segment:</strong> <span id="segment">Loading...</span></p>
        <p><strong>Contact Name:</strong> <span id="contactNameView">Loading...</span></p>
        <p><strong>Phone:</strong> <span id="contactPhoneView">Loading...</span></p>
        <p><strong>Email:</strong> <span id="contactEmailView">Loading...</span></p>
        <p><strong>Address:</strong> <span id="address">Loading...</span></p>
        <p><strong>Suburb:</strong> <span id="suburb">Loading...</span></p>
        <p><strong>State:</strong> <span id="state">Loading...</span></p>
        <p><strong>Postcode:</strong> <span id="postcode">Loading...</span></p>
        <p><strong>BDM:</strong> <span id="bdmView">Loading...</span></p>
      </div>
    </div>

    <div class="card">
      <button onclick="openEditModal()">Edit Details</button>
    </div>
  </div>

  <!-- Right Column -->
  <div class="right-column">
    <h2>Store Visit</h2> <!-- Subheader -->

    <!-- Store Visit Section -->
    <div class="card">
      <h3>Store Visit</h3>
      <div class="form-group">
        <label>Visit Reason</label>
        <select id="reason">
          <option>Planned Visit</option>
          <option>Ranging Update</option>
          <option>Tasting</option>
        </select>
      </div>
      <div class="form-group">
        <label>Outcome</label>
        <select id="outcome">
          <option>Positive</option>
          <option>Neutral</option>
          <option>Negative</option>
          <option>Follow-Up Required</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="notes" rows="4"></textarea>
      </div>
    </div>

    <!-- Preorders -->
    <div class="card">
      <h3>Preorders</h3>
      <div id="preorderContainer">Loading preorders...</div>
    </div>
    <!-- Store Range -->
    <div class="card">
      <button class="collapsible" onclick="toggleSection('storeRange')">Store Range</button>
      <div id="storeRange" class="hidden">
        <div id="storeRangeContainer">Loading store range...</div>
      </div>
    </div>
    <!-- Asset Management -->
    <div class="card">
      <button class="collapsible" onclick="toggleSection('assetForm')">Asset Management</button>
      <div id="assetForm" class="hidden">
        <div class="form-group"><label>Asset Type</label><input id="assetType" /></div>
        <div class="form-group"><label>Asset Tag Code</label><input id="assetTag" /></div>
        <div class="form-group"><label>Agreement</label><input id="assetAgreement" /></div>
        <div class="form-group"><label>Comments</label><textarea id="assetComments" rows="4"></textarea></div>
        <div id="existingAssets">Loading existing assets...</div>
      </div>
    </div>

    <!-- Email Reminder -->
    <div class="card">
      <button class="collapsible" onclick="toggleSection('emailReminder')">Email Reminder</button>
      <div id="emailReminder" class="hidden">
        <div class="form-group"><label>Date to Email</label><input type="date" id="reminderDate" /></div>
        <div class="form-group"><label>Reminder Comments</label><textarea id="reminderNotes" rows="2"></textarea></div>
      </div>
    </div>
    <!-- Previous Visit Notes -->
    <div class="card">
      <h3>Previous Visit Notes</h3>
      <div id="pastNotes">Loading previous notes...</div>
    </div>

    <!-- Current Promos -->
    <div class="card">
      <h3>Current Promos</h3>
      <div id="promoList">Loading current promos...</div>
    </div>

    <!-- Save / End Call Button -->
    <div class="card action-buttons">
      <button onclick="saveEverything()">Save / End Call</button>
    </div>

  </div> <!-- End Right Column -->

</div> <!-- End Page Layout -->

<!-- Footer -->
<footer>
  <button class="footer-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
  <button class="footer-btn" onclick="location.href='journeyplanner.html'">Journey Planner</button>
  <button class="footer-btn" onclick="location.href='reminders.html'">Reminders</button>
  <button class="footer-btn" onclick="location.href='portfolio.html'">Portfolio</button>
</footer>
<script>
// === API Endpoints ===
const customerSheet = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
const sheetUrl = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
const visitLogSheet = "https://sheetdb.io/api/v1/3jn3pg6hok7hj";
const reminderSheet = "https://sheetdb.io/api/v1/lkhkbez8p8el9";
const assetSheet = "https://sheetdb.io/api/v1/8kwtvisrhm2zd";
const preorderSheet = "https://sheetdb.io/api/v1/autq91pb2wsab";

// === Welcome Message Logic ===
const username = localStorage.getItem("username");
const bdmMap = { rhincksman: "Ryan Hincksman", chawkins: "Chris Hawkins" };
const bdmName = bdmMap[username] || "BDM";
document.getElementById("welcome").textContent = `Welcome, ${bdmName}`;

// === Customer Data Variables ===
const selectedCustomer = JSON.parse(localStorage.getItem("selectedCustomer"));
let customer = {};

// === Load Customer Details ===
function loadCustomerDetails(customerName) {
  fetch(`${customerSheet}?Customer%20Name=${encodeURIComponent(customerName)}`)
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) {
        customer = data[0];
        document.getElementById("custName").textContent = customer["Customer Name"] || "";
        document.getElementById("subOwnerGroup").textContent = customer["Sub Owner Group"] || "";
        document.getElementById("keyAccountGroup").textContent = customer["Key Account Group"] || "";
        document.getElementById("grade").textContent = customer["Grade"] || "";
        document.getElementById("storeType").textContent = customer["Store Type"] || "";
        document.getElementById("segment").textContent = customer["Segment"] || "";
        document.getElementById("contactNameView").textContent = customer["Contact Name"] || "";
        document.getElementById("contactPhoneView").textContent = customer["Phone"] || "";
        document.getElementById("contactEmailView").textContent = customer["Email"] || "";
        document.getElementById("address").textContent = customer["Address"] || "";
        document.getElementById("suburb").textContent = customer["Suburb"] || "";
        document.getElementById("state").textContent = customer["State"] || "";
        document.getElementById("postcode").textContent = customer["Postcode"] || "";
        document.getElementById("bdmView").textContent = customer["BDM"] || "";

        loadPreorders();
        loadStoreRange();
      }
    });
}

// === Toggle Collapsibles ===
function toggleSection(id) {
  const section = document.getElementById(id);
  section.classList.toggle('hidden');
}

// === Load Preorders ===
function loadPreorders() {
  fetch(`${preorderSheet}?Customer%20Name=${encodeURIComponent(customer["Customer Name"])}`)
    .then(res => res.json())
    .then(data => {
      const preorderContainer = document.getElementById("preorderContainer");
      preorderContainer.innerHTML = "";

      const skus = ["Creamy Soda", "Sarsaparilla", "Blueberry Rasp", "Portello", "LLB", "Rasp Lemonade"];

      skus.forEach(sku => {
        const div = document.createElement("div");
        div.className = "form-group";
        div.innerHTML = `
          <label>${sku}</label>
          <select id="yesno_${sku.replace(/\s+/g, '')}" onchange="toggleQTY('${sku}')">
            <option>No</option>
            <option>Yes</option>
          </select>
          <input type="number" id="qty_${sku.replace(/\s+/g, '')}" placeholder="QTY" style="display:none;margin-top:5px;" />
        `;
        preorderContainer.appendChild(div);
      });

      if (data.length > 0) {
        skus.forEach(sku => {
          const cleanSku = sku.replace(/\s+/g, '');
          if (data[0][`QTY - ${sku}`]) {
            document.getElementById(`yesno_${cleanSku}`).value = "Yes";
            document.getElementById(`qty_${cleanSku}`).style.display = "block";
            document.getElementById(`qty_${cleanSku}`).value = data[0][`QTY - ${sku}`];
          }
        });
      }
    });
}

// === Show/Hide QTY Input Based on YES/NO ===
function toggleQTY(sku) {
  const cleanSku = sku.replace(/\s+/g, '');
  const yesno = document.getElementById(`yesno_${cleanSku}`).value;
  const qty = document.getElementById(`qty_${cleanSku}`);
  qty.style.display = (yesno === "Yes") ? "block" : "none";
}

// === Load Store Range (Grouped by Brand + Tickboxes) ===
function loadStoreRange() {
  fetch(`${customerSheet}?Customer%20Name=${encodeURIComponent(customer["Customer Name"])}`)
    .then(res => res.json())
    .then(data => {
      const storeRangeContainer = document.getElementById("storeRangeContainer");
      storeRangeContainer.innerHTML = "";

      const brandGroups = {};

      if (data.length > 0) {
        const range = JSON.parse(data[0]["Store Range"] || "{}");

        Object.keys(range).forEach(product => {
          const [brand, sku] = product.split(" - ");
          if (!brandGroups[brand]) brandGroups[brand] = [];
          brandGroups[brand].push({ sku, ranged: range[product] === "Yes" });
        });

        Object.keys(brandGroups).forEach(brand => {
          const brandDiv = document.createElement("div");
          brandDiv.innerHTML = `<h4>${brand}</h4>`;
          storeRangeContainer.appendChild(brandDiv);

          brandGroups[brand].forEach(item => {
            const div = document.createElement("div");
            div.className = "form-group";
            div.innerHTML = `
              <label>
                <input type="checkbox" ${item.ranged ? "checked" : ""} id="range_${brand}_${item.sku.replace(/\s+/g, '')}" />
                ${item.sku}
              </label>
            `;
            storeRangeContainer.appendChild(div);
          });
        });
      }
    });
}

// === Save Everything (Visit, Preorders, Range, Asset, Reminder) ===
function saveEverything() {
  const now = new Date();
  const visitReason = document.getElementById("reason").value;
  const outcome = document.getElementById("outcome").value;
  const notes = document.getElementById("notes").value.trim();

  if (visitReason && notes && (visitReason === "Planned Visit" || visitReason === "Tasting")) {
    const visit = {
      "Date": now.toISOString().split("T")[0],
      "Timestamp": now.toLocaleString(),
      "Customer Name": customer["Customer Name"],
      "BDM": customer["BDM"],
      "Visit Reason": visitReason,
      "Outcome": outcome,
      "Notes": notes,
      "Status": "Completed"
    };
    fetch(visitLogSheet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: visit })
    });
  }

  // Reminder
  const reminderDate = document.getElementById("reminderDate").value;
  const reminderNotes = document.getElementById("reminderNotes").value.trim();
  if (reminderDate) {
    fetch(reminderSheet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: {
        "Date to Email": reminderDate,
        "Customer Name": customer["Customer Name"],
        "BDM": customer["BDM"],
        "Comments": reminderNotes
      } })
    });
  }

  // Assets
  const assetType = document.getElementById("assetType").value.trim();
  const assetTag = document.getElementById("assetTag").value.trim();
  const agreement = document.getElementById("assetAgreement").value.trim();
  const assetComments = document.getElementById("assetComments").value.trim();
  if (assetType && assetTag && agreement && assetComments) {
    fetch(assetSheet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: {
        "Customer Name": customer["Customer Name"],
        "Asset Type": assetType,
        "Asset Tag Code": assetTag,
        "Agreement": agreement,
        "Asset Comments": assetComments
      } })
    });
  }

  // Preorders
  const preorderData = {};
  const skus = ["Creamy Soda", "Sarsaparilla", "Blueberry Rasp", "Portello", "LLB", "Rasp Lemonade"];
  skus.forEach(sku => {
    const cleanSku = sku.replace(/\s+/g, '');
    if (document.getElementById(`yesno_${cleanSku}`).value === "Yes") {
      preorderData[`QTY - ${sku}`] = document.getElementById(`qty_${cleanSku}`).value || "1";
    }
  });

  if (Object.keys(preorderData).length > 0) {
    fetch(`${preorderSheet}?Customer%20Name=${encodeURIComponent(customer["Customer Name"])}`)
      .then(res => res.json())
      .then(existing => {
        const method = existing.length ? "PATCH" : "POST";
        const url = existing.length
          ? `${preorderSheet}/Customer%20Name/${encodeURIComponent(customer["Customer Name"])}`
          : preorderSheet;
        fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: { "Customer Name": customer["Customer Name"], ...preorderData } })
        });
      });
  }

  alert("Save / End Call Completed");
  window.location.href = "dashboard.html";
}

// Load on Page Ready
if (selectedCustomer) {
  loadCustomerDetails(selectedCustomer["Customer Name"]);
} else {
  window.location.href = "dashboard.html";
}
</script>
</body>
</html>
