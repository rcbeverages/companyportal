<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visit Log - RC Beverages</title>
  
  <!-- Global styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Visit.html-specific styles -->
  <style>
    /* Layout containers */
    .page-layout {
  display: flex;
  height: auto;
  padding: 15px;
  gap: 20px;
  box-sizing: border-box;
  align-items: flex-start;
}

.left-column {
  position: absolute;
  top: 160px;
  bottom: 80px;
  left: 5%;
  width: 28%;
  padding: 100px;
  background: #eef3fd;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  overflow-y: auto;
  box-sizing: border-box;
}

.right-column {
  position: absolute;
  top: 100px;
  bottom: 80px;
  right: 5%;
  width: 60%;
  padding: 20px;
  background-color: white;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  overflow-y: auto;
  box-sizing: border-box;
}

    /* Edit Details button style (matches footer buttons) */
    .edit-btn {
      background-color: #0057b7;
      color: white;
      border: none;
      padding: 10px 20px;
      margin-top: 10px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
    }

    .edit-btn:hover {
      background-color: #0041a3;
    }

    /* Modal styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-sizing: border-box;
    }

    .modal-content h2 {
  margin-bottom: 20px;
}

.modal-content .form-group {
  margin-bottom: 15px;
}

.modal-content label {
  display: block;
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 14px;
}

.modal-content input,
.modal-content select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  box-sizing: border-box;
}

.modal-content button {
  margin-top: 20px;
  width: 100%;
  background-color: #0057b7;
  color: white;
  border: none;
  padding: 12px;
  border-radius: 25px;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
}

.modal-content button:hover {
  background-color: #0041a3;
}


    .close-btn {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #0057b7;
    }

    .close-btn:hover {
      color: darkred;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header>
    <h1>Visit Log</h1>
  </header>

<!-- Welcome Message -->
<div class="welcome-message" id="welcome">
  <!-- Will be filled dynamically -->
</div>

<!-- Page Layout Start -->
<div class="page-layout">

  <!-- Left Column -->
  <div class="left-column">
    <h2>Customer Details</h2> <!-- Subheader -->

    <div class="card">
      <div id="detailsContent">
        <p><strong>Customer Name:</strong> <span id="custName">Loading...</span></p>
        <p><strong>Sub Owner Group:</strong> <span id="subOwnerGroup">Loading...</span></p>
        <p><strong>Key Account Group:</strong> <span id="keyAccountGroup">Loading...</span></p>
        <p><strong>Grade:</strong> <span id="grade">Loading...</span></p>
        <p><strong>Store Type:</strong> <span id="storeType">Loading...</span></p>
        <p><strong>Segment:</strong> <span id="segment">Loading...</span></p>
        <p><strong>Contact Name:</strong> <span id="contactNameView">Loading...</span></p>
        <p><strong>Phone:</strong> <span id="contactPhoneView">Loading...</span></p>
        <p><strong>Email:</strong> <span id="contactEmailView">Loading...</span></p>
        <p><strong>Address:</strong> <span id="address">Loading...</span></p>
        <p><strong>Suburb:</strong> <span id="suburb">Loading...</span></p>
        <p><strong>State:</strong> <span id="state">Loading...</span></p>
        <p><strong>Postcode:</strong> <span id="postcode">Loading...</span></p>
        <p><strong>BDM:</strong> <span id="bdmView">Loading...</span></p>
      </div>
    </div>

    <div class="card">
      <button class="edit-btn" onclick="openStoreModal()">Edit Store</button>
      <button class="edit-btn" onclick="openContactModal()">Edit Contact</button>
      <button class="edit-btn" onclick="openAddressModal()">Edit Address</button>
      <!-- Edit Details Modal -->
<!-- Edit Store Modal -->
<div id="storeModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('storeModal')">&times;</span>
    <h2>Edit Store Info</h2>
    <div class="form-group"><label>Customer Name</label><input id="editCustomerName" required /></div>
    <div class="form-group"><label>Sub Owner Group</label><select id="editSubOwnerGroup"></select></div>
    <div class="form-group"><label>Key Account Group</label><select id="editKeyAccountGroup"></select></div>
    <div class="form-group"><label>Grade</label><select id="editGrade"></select></div>
    <div class="form-group"><label>Store Type</label><select id="editStoreType"></select></div>
    <div class="form-group"><label>Segment</label><select id="editSegment"></select></div>
    <div class="form-group"><label>BDM</label><select id="editBDM"></select></div>
    <button onclick="saveStoreInfo()">Save Changes</button>
  </div>
</div>

<!-- Edit Contact Modal -->
<div id="contactModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('contactModal')">&times;</span>
    <h2>Edit Contact Info</h2>
    <div class="form-group"><label>Contact Name</label><input id="editContactName" /></div>
    <div class="form-group"><label>Phone</label><input id="editPhone" /></div>
    <div class="form-group"><label>Email</label><input id="editEmail" /></div>
    <button onclick="saveContactInfo()">Save Changes</button>
  </div>
</div>

<!-- Edit Address Modal -->
<div id="addressModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('addressModal')">&times;</span>
    <h2>Edit Address</h2>
    <div class="form-group"><label>Address</label><input id="editAddress" /></div>
    <div class="form-group"><label>Suburb</label><input id="editSuburb" /></div>
    <div class="form-group"><label>State</label><input id="editState" /></div>
    <div class="form-group"><label>Postcode</label><input id="editPostcode" /></div>
    <button onclick="saveAddressInfo()">Save Changes</button>
  </div>
</div>


    </div>
  </div>

  <!-- Right Column -->
  <div class="right-column">
    <h2>Store Visit</h2> <!-- Subheader -->

    <!-- Store Visit Section -->
    <div class="card">
      <h3>Store Visit</h3>
      <div class="form-group">
        <label>Visit Reason</label>
        <select id="reason">
          <option>Planned Visit</option>
          <option>Ranging Update</option>
          <option>Tasting</option>
        </select>
      </div>
      <div class="form-group">
        <label>Outcome</label>
        <select id="outcome">
          <option>Positive</option>
          <option>Neutral</option>
          <option>Negative</option>
          <option>Follow-Up Required</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="notes" rows="4"></textarea>
      </div>
    </div>

    <!-- Preorders -->
    <div class="card">
      <h3>Preorders</h3>
      <div id="preorderContainer">Loading preorders...</div>
    </div>
    <!-- Store Range -->
    <div class="card">
      <button class="collapsible" onclick="toggleSection('storeRange')">Store Range</button>
      <div id="storeRange" class="hidden">
        <div id="storeRangeContainer">Loading store range...</div>
      </div>
    </div>
    <!-- Asset Management -->
    <div class="card">
      <button class="collapsible" onclick="toggleSection('assetForm')">Asset Management</button>
      <div id="assetForm" class="hidden">
        <div class="form-group"><label>Asset Type</label><input id="assetType" /></div>
        <div class="form-group"><label>Asset Tag Code</label><input id="assetTag" /></div>
        <div class="form-group"><label>Agreement</label><input id="assetAgreement" /></div>
        <div class="form-group"><label>Comments</label><textarea id="assetComments" rows="4"></textarea></div>
        <div id="existingAssets">Loading existing assets...</div>
      </div>
    </div>

    <!-- Email Reminder -->
    <div class="card">
      <button class="collapsible" onclick="toggleSection('emailReminder')">Email Reminder</button>
      <div id="emailReminder" class="hidden">
        <div class="form-group"><label>Date to Email</label><input type="date" id="reminderDate" /></div>
        <div class="form-group"><label>Reminder Comments</label><textarea id="reminderNotes" rows="2"></textarea></div>
      </div>
    </div>
    <!-- Previous Visit Notes -->
    <div class="card">
      <h3>Previous Visit Notes</h3>
      <div id="pastNotes">Loading previous notes...</div>
    </div>

    <!-- Current Promos -->
    <div class="card">
      <h3>Current Promos</h3>
      <div id="promoList">Loading current promos...</div>
    </div>

    <!-- Save / End Call Button -->
    <div class="card action-buttons">
      <button onclick="saveEverything()">Save / End Call</button>
    </div>

  </div> <!-- End Right Column -->

</div> <!-- End Page Layout -->

<!-- Footer -->
<footer>
 <button class="footer-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
    <button class="footer-btn" onclick="location.href='comms.html'">Communication</button>
    <button class="footer-btn" onclick="location.href='journeyplanners.html'">Journey Planner</button>
    <button class="footer-btn" onclick="location.href='reminders.html'">Reminders</button>
    <button class="footer-btn" onclick="location.href='portfolio.html'">Portfolio</button>
</footer>
  
<script>
  function populateStoreFields() {
  document.getElementById("editCustomerName").value = customer["Customer Name"] || "";
  populateDropdown("editSubOwnerGroup", "Sub Owner Group", customer["Sub Owner Group"]);
  populateDropdown("editKeyAccountGroup", "Key Account Group", customer["Key Account Group"]);
  populateDropdown("editGrade", "Grade", customer["Grade"]);
  populateDropdown("editStoreType", "Store Type", customer["Store Type"]);
  populateDropdown("editSegment", "Segment", customer["Segment"]);
  populateDropdown("editBDM", "BDM", customer["BDM"]);
}

function populateContactFields() {
  document.getElementById("editContactName").value = customer["Contact Name"] || "";
  document.getElementById("editPhone").value = customer["Phone"] || "";
  document.getElementById("editEmail").value = customer["Email"] || "";
}

function populateAddressFields() {
  document.getElementById("editAddress").value = customer["Address"] || "";
  document.getElementById("editSuburb").value = customer["Suburb"] || "";
  document.getElementById("editState").value = customer["State"] || "";
  document.getElementById("editPostcode").value = customer["Postcode"] || "";
}

function saveCustomerFields(updatedFields) {
  fetch(`${sheetUrl}/Customer Name/${encodeURIComponent(customer["Customer Name"])}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ data: updatedFields })
  }).then(() => {
    window.location.reload();
  });
}

function saveStoreInfo() {
  const updated = {
    "Customer Name": document.getElementById("editCustomerName").value.trim(),
    "Sub Owner Group": document.getElementById("editSubOwnerGroup").value,
    "Key Account Group": document.getElementById("editKeyAccountGroup").value,
    "Grade": document.getElementById("editGrade").value,
    "Store Type": document.getElementById("editStoreType").value,
    "Segment": document.getElementById("editSegment").value,
    "BDM": document.getElementById("editBDM").value
  };
  saveCustomerFields(updated);
  closeModal("storeModal");
}

function saveContactInfo() {
  const updated = {
    "Contact Name": document.getElementById("editContactName").value.trim(),
    "Phone": document.getElementById("editPhone").value.trim(),
    "Email": document.getElementById("editEmail").value.trim()
  };
  saveCustomerFields(updated);
  closeModal("contactModal");
}

function saveAddressInfo() {
  const updated = {
    "Address": document.getElementById("editAddress").value.trim(),
    "Suburb": document.getElementById("editSuburb").value.trim(),
    "State": document.getElementById("editState").value.trim(),
    "Postcode": document.getElementById("editPostcode").value.trim()
  };
  saveCustomerFields(updated);
  closeModal("addressModal");
}

// Reuse dropdown builder (already in your original code)
function populateDropdown(selectId, columnName, selectedValue) {
  fetch(`${customerSheet}?limit=1000`)
    .then(res => res.json())
    .then(data => {
      const uniqueOptions = [...new Set(data.map(row => row[columnName]).filter(Boolean))];
      const select = document.getElementById(selectId);
      select.innerHTML = "";

      // ✅ Add a blank option ONLY if it's Sub Owner Group
      if (selectId === "editSubOwnerGroup") {
        const blank = document.createElement("option");
        blank.value = "";
        blank.textContent = "";
        select.appendChild(blank);
      }

      uniqueOptions.sort().forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        if (option === selectedValue) opt.selected = true;
        select.appendChild(opt);
      });
    });
}


// === API Endpoints ===
const customerSheet = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
const sheetUrl = "https://sheetdb.io/api/v1/8ba1eug88u4y1";
const visitLogSheet = "https://sheetdb.io/api/v1/3jn3pg6hok7hj";
const reminderSheet = "https://sheetdb.io/api/v1/lkhkbez8p8el9";
const assetSheet = "https://sheetdb.io/api/v1/8kwtvisrhm2zd";
const preorderSheet = "https://sheetdb.io/api/v1/autq91pb2wsab";

// === Welcome Message Logic ===
const username = localStorage.getItem("username");
const bdmMap = { rhincksman: "Ryan Hincksman", chawkins: "Chris Hawkins" };
const bdmName = bdmMap[username] || "BDM";
document.getElementById("welcome").textContent = `Welcome, ${bdmName}`;

// === Customer Data Variables ===
const selectedCustomer = JSON.parse(localStorage.getItem("selectedCustomer"));

if (selectedCustomer) {
  displayCustomerDetails(selectedCustomer);
} else {
  window.location.href = "storedatabase.html";
}

// === Load Customer Details ===
function displayCustomerDetails(customer) {
  document.getElementById("custName").textContent = customer["Customer Name"] || "";
  document.getElementById("subOwnerGroup").textContent = customer["Sub Owner Group"] || "";
  document.getElementById("keyAccountGroup").textContent = customer["Key Account Group"] || "";
  document.getElementById("grade").textContent = customer["Grade"] || "";
  document.getElementById("storeType").textContent = customer["Store Type"] || "";
  document.getElementById("segment").textContent = customer["Segment"] || "";
  document.getElementById("contactNameView").textContent = customer["Contact Name"] || "";
  document.getElementById("contactPhoneView").textContent = customer["Phone"] || "";
  document.getElementById("contactEmailView").textContent = customer["Email"] || "";
  document.getElementById("address").textContent = customer["Address"] || "";
  document.getElementById("suburb").textContent = customer["Suburb"] || "";
  document.getElementById("state").textContent = customer["State"] || "";
  document.getElementById("postcode").textContent = customer["Postcode"] || "";
  document.getElementById("bdmView").textContent = customer["BDM"] || "";

  // Optional: trigger other sections after customer is displayed
  loadPreorders();
  loadStoreRange();
}

    });
}

// === Toggle Collapsibles ===
function toggleSection(id) {
  const section = document.getElementById(id);
  section.classList.toggle('hidden');
}

// === Load Preorders ===
function loadPreorders() {
  fetch(`${preorderSheet}?Customer%20Name=${encodeURIComponent(customer["Customer Name"])}`)
    .then(res => res.json())
    .then(data => {
      const preorderContainer = document.getElementById("preorderContainer");
      preorderContainer.innerHTML = "";

      const skus = ["Creamy Soda", "Sarsaparilla", "Blueberry Rasp", "Portello", "LLB", "Rasp Lemonade"];

      skus.forEach(sku => {
        const div = document.createElement("div");
        div.className = "form-group";
        div.innerHTML = `
          <label>${sku}</label>
          <select id="yesno_${sku.replace(/\s+/g, '')}" onchange="toggleQTY('${sku}')">
            <option>No</option>
            <option>Yes</option>
          </select>
          <input type="number" id="qty_${sku.replace(/\s+/g, '')}" placeholder="QTY" style="display:none;margin-top:5px;" />
        `;
        preorderContainer.appendChild(div);
      });

      if (data.length > 0) {
        skus.forEach(sku => {
          const cleanSku = sku.replace(/\s+/g, '');
          if (data[0][`QTY - ${sku}`]) {
            document.getElementById(`yesno_${cleanSku}`).value = "Yes";
            document.getElementById(`qty_${cleanSku}`).style.display = "block";
            document.getElementById(`qty_${cleanSku}`).value = data[0][`QTY - ${sku}`];
          }
        });
      }
    });
}

// === Show/Hide QTY Input Based on YES/NO ===
function toggleQTY(sku) {
  const cleanSku = sku.replace(/\s+/g, '');
  const yesno = document.getElementById(`yesno_${cleanSku}`).value;
  const qty = document.getElementById(`qty_${cleanSku}`);
  qty.style.display = (yesno === "Yes") ? "block" : "none";
}

// === Load Store Range (Grouped by Brand + Tickboxes) ===
function loadStoreRange() {
  fetch(`${customerSheet}?Customer%20Name=${encodeURIComponent(customer["Customer Name"])}`)
    .then(res => res.json())
    .then(data => {
      const storeRangeContainer = document.getElementById("storeRangeContainer");
      storeRangeContainer.innerHTML = "";

      const brandGroups = {};

      if (data.length > 0) {
        const range = JSON.parse(data[0]["Store Range"] || "{}");

        Object.keys(range).forEach(product => {
          const [brand, sku] = product.split(" - ");
          if (!brandGroups[brand]) brandGroups[brand] = [];
          brandGroups[brand].push({ sku, ranged: range[product] === "Yes" });
        });

        Object.keys(brandGroups).forEach(brand => {
          const brandDiv = document.createElement("div");
          brandDiv.innerHTML = `<h4>${brand}</h4>`;
          storeRangeContainer.appendChild(brandDiv);

          brandGroups[brand].forEach(item => {
            const div = document.createElement("div");
            div.className = "form-group";
            div.innerHTML = `
              <label>
                <input type="checkbox" ${item.ranged ? "checked" : ""} id="range_${brand}_${item.sku.replace(/\s+/g, '')}" />
                ${item.sku}
              </label>
            `;
            storeRangeContainer.appendChild(div);
          });
        });
      }
    });
}

// === Save Everything (Visit, Preorders, Range, Asset, Reminder) ===
function saveEverything() {
  const now = new Date();
  const visitReason = document.getElementById("reason").value;
  const outcome = document.getElementById("outcome").value;
  const notes = document.getElementById("notes").value.trim();

  if (visitReason && notes && (visitReason === "Planned Visit" || visitReason === "Tasting")) {
    const visit = {
      "Date": now.toISOString().split("T")[0],
      "Timestamp": now.toLocaleString(),
      "Customer Name": customer["Customer Name"],
      "BDM": customer["BDM"],
      "Visit Reason": visitReason,
      "Outcome": outcome,
      "Notes": notes,
      "Status": "Completed"
    };
    fetch(visitLogSheet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: visit })
    });
  }

  // Reminder
  const reminderDate = document.getElementById("reminderDate").value;
  const reminderNotes = document.getElementById("reminderNotes").value.trim();
  if (reminderDate) {
    fetch(reminderSheet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: {
        "Date to Email": reminderDate,
        "Customer Name": customer["Customer Name"],
        "BDM": customer["BDM"],
        "Comments": reminderNotes
      } })
    });
  }

  // Assets
  const assetType = document.getElementById("assetType").value.trim();
  const assetTag = document.getElementById("assetTag").value.trim();
  const agreement = document.getElementById("assetAgreement").value.trim();
  const assetComments = document.getElementById("assetComments").value.trim();
  if (assetType && assetTag && agreement && assetComments) {
    fetch(assetSheet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: {
        "Customer Name": customer["Customer Name"],
        "Asset Type": assetType,
        "Asset Tag Code": assetTag,
        "Agreement": agreement,
        "Asset Comments": assetComments
      } })
    });
  }

  // Preorders
  const preorderData = {};
  const skus = ["Creamy Soda", "Sarsaparilla", "Blueberry Rasp", "Portello", "LLB", "Rasp Lemonade"];
  skus.forEach(sku => {
    const cleanSku = sku.replace(/\s+/g, '');
    if (document.getElementById(`yesno_${cleanSku}`).value === "Yes") {
      preorderData[`QTY - ${sku}`] = document.getElementById(`qty_${cleanSku}`).value || "1";
    }
  });

  if (Object.keys(preorderData).length > 0) {
    fetch(`${preorderSheet}?Customer%20Name=${encodeURIComponent(customer["Customer Name"])}`)
      .then(res => res.json())
      .then(existing => {
        const method = existing.length ? "PATCH" : "POST";
        const url = existing.length
          ? `${preorderSheet}/Customer%20Name/${encodeURIComponent(customer["Customer Name"])}`
          : preorderSheet;
        fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: { "Customer Name": customer["Customer Name"], ...preorderData } })
        });
      });
  }

  alert("Save / End Call Completed");
  window.location.href = "dashboard.html";
}

// Load on Page Ready
if (selectedCustomer) {
  loadCustomerDetails(selectedCustomer["Customer Name"]);
} else {
  window.location.href = "dashboard.html";
}

// === Open Edit Modal ===
function openStoreModal() {
  populateStoreFields();
  document.getElementById("storeModal").style.display = "block";
}

function openContactModal() {
  populateContactFields();
  document.getElementById("contactModal").style.display = "block";
}

function openAddressModal() {
  populateAddressFields();
  document.getElementById("addressModal").style.display = "block";
}

function closeModal(id) {
  document.getElementById(id).style.display = "none";
}

</script>
</body>
</html>
